import{r as n,S as Q,U as V,X as Y,a7 as H,u as K,g as U,h as $,j as t,i as J,y as Z,C as ee,z as te,m as D,B as se,v as re,n as ae,T as oe,aB as ne,q as le,bB as ie,l as ce,a2 as ue,s as de,G as me,J as xe,bD as pe,bE as fe,_ as he,K as j,w as ge,x as Se,ae as je}from"./index-c7bc4969.js";import{A as be}from"./AnimatedContainer-e139da34.js";import{h as Ce}from"./ExaminationAPI-f55359a2.js";import{g as ye}from"./generateCustomGrade-93281c1e.js";import{N as Ee}from"./NoteRounded-7b8c486a.js";const De=({open:w,setOpen:B,grades:P,defaultSubject:c,classLevelId:k})=>{var T,I;const b="text/csv",A="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",R="application/vnd.ms-excel",{schoolSessionDispatch:x}=n.useContext(Q),{userState:{session:i}}=n.useContext(V);Y();const{levelId:p}=H(),C=K(),[r,u]=n.useState([]),[y,l]=n.useState(!1),[E,v]=n.useState(""),[F,f]=n.useState(""),[a,_]=n.useState(c),h=U({queryKey:["subjects"],queryFn:()=>je(p),enabled:!!p});n.useEffect(()=>{if((r==null?void 0:r.length)>0){const e=r==null?void 0:r.map(s=>({...s,subject:a}));u(e)}},[a]);function N(e){if(a===""){v("Please select a Subject!"),l(!1);return}f(!1),l(!0);const s=e.target.files[0];try{const o=new FileReader;s.type===b?o.readAsBinaryString(s):o.readAsArrayBuffer(s),o.onload=async function(L){let d=[];if((s.type===A||s.type===R)&&(d=pe(L.target.result)),s.type===b&&(d=fe(L.target.result)),d.length!==0){const z=d.map(m=>{const g=Number(Object.values(m)[2]||0),S=Number(Object.values(m)[3]||0);if(g>50||S>50)throw f("It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50 marks!"),l(!1),u([]),"It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50";return{indexnumber:he.toString(Object.values(m)[0]),student:Object.values(m)[1],subject:a,classScore:g,examsScore:S,...ye(+g+ +S,P)}}),G=await Promise.all(z);u(G)}}}catch(o){f(o)}finally{l(!1)}}const q=()=>{j.fire({title:"Exiting",text:"Do you want to exit?",showCancelButton:!0,backdrop:!1}).then(({isConfirmed:e})=>{e&&B(!1)})},O=()=>{j.fire({title:"Discarding",text:"Discard Changes?",showCancelButton:!0,backdrop:!1}).then(({isConfirmed:e})=>{e&&u([])})},{mutateAsync:X}=$({mutationFn:Ce}),M=()=>{v(""),l(!0),j.fire({title:"Importing results",text:`Do you want to import results in ${a}?`,showCancelButton:!0}).then(({isConfirmed:e})=>{if(e){const s={session:i==null?void 0:i.sessionId,term:i==null?void 0:i.termId,level:p||k,results:r};X(s,{onSettled:()=>{C.invalidateQueries(["all-results"]),C.invalidateQueries(["subject-score"]),l(!1)},onSuccess:o=>{x(ge(o)),x({type:"closeAddResultFileDialog"})},onError:o=>{x(Se(o))}})}l(!1)})},W=[{title:"Index Number",field:"indexnumber"},{title:"Student",field:"student"},{title:"Subject",field:"subject",hidden:a||c},{title:"Class Score(50%)",field:"classScore"},{title:"Exams Score(50%)",field:"examsScore"},{title:"Total Score(100%)",field:"totalScore"},{title:"Grade",field:"grade"},{title:"Remarks",field:"remarks"}];return t.jsxs(J,{maxWidth:"lg",TransitionComponent:Z,open:w,fullWidth:!0,children:[t.jsx(ee,{title:"Exams Scores",subtitle:"Import Student exams results from excel or csv files.",onClose:q}),t.jsx(te,{children:t.jsxs(D,{spacing:2,px:4,children:[(r==null?void 0:r.length)>0&&t.jsx(be,{children:t.jsxs(D,{direction:"row",spacing:3,justifyContent:"flex-end",children:[t.jsx(se,{onClick:O,children:"Cancel"}),t.jsx(re,{variant:"contained",onClick:M,children:"Save Results"})]})}),t.jsx(ae,{options:(T=h.data)!=null&&T.subjects?(I=h.data)==null?void 0:I.subjects:[c],loading:h.isLoading,getOptionLabel:e=>e||"",isOptionEqualToValue:(e,s)=>s===void 0||s===""||s===e,defaultValue:c,value:a,onChange:(e,s)=>_(s),sx:{minWidth:350},renderInput:e=>t.jsx(oe,{...e,label:"Select Subject",size:"small",sx:{maxWidth:300},error:E!=="",helperText:E,required:!0,FormHelperTextProps:{sx:{color:"error.main"}}})}),t.jsxs(ne,{htmlFor:"resultFile",title:"Import results",sx:{display:"flex",justifyContent:"center",alignItems:"center",border:"1px solid lightgray",width:300,padding:1,gap:1,color:"primary.main",fontSize:11,cursor:"pointer"},children:[t.jsx(Ee,{}),t.jsx(le,{variant:"caption",children:y?"Please Wait...":"Select Subject File"}),t.jsx(ie,{type:"file",id:"resultFile",name:"resultFile",hidden:!0,inputProps:{accept:".xlsx,.xls,.csv"},onChange:e=>N(e),onClick:e=>{e.target.value=null,e.currentTarget.value=null}})]})]})}),t.jsx(ce,{children:t.jsxs(ue,{children:[F&&t.jsx(de,{sx:{color:"red"},children:F}),t.jsx(me,{icon:xe.score,search:!0,exportFileName:`${a} - `,isLoading:y,title:a,columns:W,data:r,pa:!0,actions:[]})]})})]})};export{De as default};
