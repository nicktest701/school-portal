import{p as de,j as e,r as c,S as ce,a1 as pe,u as ue,n as me,d as he,C as xe,e as fe,x as ge,k as v,l as E,T as b,a0 as j,P as A,aC as je,B as L,a9 as ye,_ as P,H as Ce,f as O,g as ve,h as Se,G as Te}from"./index-B8PQHtjc.js";import{C as be,r as we,u as Ie}from"./CustomizedMaterialTable-BQoTtwVw.js";import{u as _e,A as Ee}from"./index-CeIRQj8o.js";import{I as B,E as Le}from"./images-B5fNBSni.js";import{C as Pe}from"./CustomFormControl-Duiznp8E.js";import{I as De,d as Fe}from"./sessionColumns-oq904N9H.js";import{I as Me}from"./studentColumns-mOrPrRKB.js";import{I as Ne}from"./teacherColumn-BYJUIpnE.js";import{p as Re}from"./sessionAPI-C-E5-YJ-.js";import{u as Ue}from"./useLevel-K9fH0Cop.js";import{A as ke}from"./Autocomplete-Dw57Ihk7.js";import{L as Ae}from"./Link-kLE4_HTq.js";import{v as Oe}from"./v4-C6aID195.js";import"./TabPanel-WHfZdNAn.js";import"./useThemeProps-CEPKeDia.js";import"./Toolbar-YM__bEFh.js";import"./Chip-DmEpgF7y.js";import"./Skeleton-DWRiBFRT.js";import"./ButtonGroup-ZC3qSltg.js";import"./ListItemText-DzMM1D1F.js";import"./InputAdornment-DAOlZ4uj.js";import"./index-BqG4A_N5.js";import"./DialogActions-BmNk8sop.js";import"./ListItem-CQImyTSy.js";import"./ListItemSecondaryAction-DOVMjMKm.js";import"./listItemButtonClasses-DySKLRoc.js";import"./Grid2-B2FVLpOz.js";import"./ListItemButton-Di0YOqWQ.js";import"./Check-JB41DPzl.js";import"./DeleteOutline-BlPFLwFk.js";import"./currencyFormatter-DjBDW3hY.js";import"./CircleRounded-YWo57tpF.js";import"./gradeColor-B1MTvGsq.js";const Be=de(e.jsx("path",{d:"m19.41 7.41-4.83-4.83c-.37-.37-.88-.58-1.41-.58H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8.83c0-.53-.21-1.04-.59-1.42M14.8 15H13v3c0 .55-.45 1-1 1s-1-.45-1-1v-3H9.21c-.45 0-.67-.54-.35-.85l2.8-2.79c.2-.19.51-.19.71 0l2.79 2.79c.3.31.08.85-.36.85M14 9c-.55 0-1-.45-1-1V3.5L18.5 9z"}),"UploadFileRounded");function ze(w){switch(w){case"students":return Me;case"teachers":return Ne;case"subjects":return Fe;case"grades":return De;default:return[]}}const St=()=>{var k;const w="text/csv",z="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",V="application/vnd.ms-excel",{schoolSessionDispatch:D}=c.useContext(ce),{userState:{session:f}}=c.useContext(pe),H=ue(),{state:I}=me(),[y,G]=c.useState({_id:"",type:""}),[r,F]=c.useState("students"),[o,M]=c.useState("personal-data"),[_,W]=c.useState(""),[l,p]=c.useState([]),[Y,Ve]=c.useState(!1),[N,R]=c.useState(""),{levelsOption:X}=Ue(),{getRootProps:q,getInputProps:$,open:J,acceptedFiles:K}=_e({noClick:!0,noKeyboard:!0,maxFiles:20,accept:o==="personal-data"?{"text/csv":[".csv"],"application/vnd.ms-excel":[".xls"],"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"]}:{"image/*":[".jpeg",".png",".webp"]},maxSize:2e5,multiple:!0,onDrop:t=>{P.isEmpty(t)?R("No files selected"):(o==="personal-data"&&Z(t[0]),o==="photos"&&ee(t))}}),U=(k=K[0])==null?void 0:k.type,Q={dataCategory:r,dataType:o,levelValue:y,data:l,gradeName:_};function Z(t){try{const s=new FileReader;s.onload=async function(i){var n;const a=(n=i.target)==null?void 0:n.result;if(a){const u=we(a,{type:"binary"}),m=u.SheetNames[0],g=u.Sheets[m],S=Ie.sheet_to_json(g,{header:1}),C=S[0].map(x=>P.camelCase(x)),h=S.slice(1).map(x=>{const d={};return C.forEach((le,ie)=>{d[le]=x[ie]}),d});if(p([]),r==="grades"){const x=h==null?void 0:h.map(d=>({id:Oe(),...d}));p(x);return}if(r==="subjects"){const x=h==null?void 0:h.map(d=>({...d,isCore:!!["Yes","True",!0].includes(d==null?void 0:d.isCore)}));p(x);return}p(h)}},s.readAsBinaryString(t)}catch(s){R(s)}finally{}}function ee(t){const i=Array.from(t).map(async a=>{var m;const u=await new Promise((g,S)=>{const C=new FileReader;C.onload=T=>{g(T.target.result)},C.onerror=T=>{S(T)},C.readAsDataURL(a)});return{id:(m=a.name)==null?void 0:m.split(".")[0],src:u}});Promise.all(i).then(a=>{p([]),p(a)}).catch(a=>{console.error("Error reading files: ",a)}).finally(()=>{})}const{mutateAsync:te,isPending:ae}=he({mutationFn:Re}),se=()=>{O.fire({title:"Importing results",text:`You are about to import ${r} ${o}.Proceed with import?`,showCancelButton:!0,backdrop:!1}).then(({isConfirmed:t})=>{if(t){let s;["students","teachers"].includes(r)&&(s={dataCategory:r,dataType:o,data:{session:{sessionId:f==null?void 0:f.sessionId,termId:f==null?void 0:f.termId,levelId:y==null?void 0:y._id},students:l,type:"file"}}),r==="grades"&&(s={dataCategory:r,dataType:o,data:{name:_,ratings:l}}),r==="subjects"&&(s={dataCategory:r,dataType:o,data:l}),te(s,{onSuccess:i=>{D(ve(i)),H(I==null?void 0:I.prevPath)},onError:i=>{D(Se(i))}})}})},re=async()=>{await Te(r)},oe=()=>{O.fire({title:"Cancel Uploads",text:"Unsaved Changes will be lost. Are you sure?",showCancelButton:!0,allowOutsideClick:()=>!1,closeOnClickOutside:!1,backdrop:" rgba(0,0,0,0.4)"}).then(({isConfirmed:t})=>{t&&(F("students"),M("personal-data"),p([]))})},ne=ze(r);return e.jsxs(xe,{children:[e.jsx(fe,{title:"Data Uploads (Bulk Data Management)",subtitle:"Upload large sets of data, such as student information,teacher information,subjects, grades, and attendance records, to streamline data entry and management processes.",color:"primary.main"}),e.jsx(ge,{initialValues:Q,onSubmit:se,enableReinitialize:!0,children:({errors:t,touched:s,handleSubmit:i})=>e.jsxs(e.Fragment,{children:[e.jsxs(v,{spacing:2,py:4,px:2,my:4,border:"1px solid lightgray",borderRadius:"12px",children:[e.jsxs(E,{children:["Select an ",e.jsx("b",{children:"EXCEL"})," OR ",e.jsx("b",{children:"CSV"})," file containing student the data. Make sure the ",e.jsx("b",{children:"columns"})," matches the accepted fields. You can download a ",e.jsx("b",{children:"sample template"})," for your data."]}),e.jsxs(e.Fragment,{children:[e.jsxs(v,{py:2,children:[e.jsxs(Pe,{children:[e.jsx("div",{style:{width:"inherit"},children:e.jsxs(b,{label:"Choose Data Category",select:!0,fullWidth:!0,size:"small",value:r,onChange:a=>{F(a.target.value),p([])},error:!!(s.dataCategory&&t.dataCategory),helperText:s.dataCategory&&t.dataCategory,children:[e.jsx(j,{value:"students",children:"Students"}),e.jsx(j,{value:"teachers",children:"Teachers"}),e.jsx(j,{value:"subjects",children:"Subjects"}),e.jsx(j,{value:"grades",children:"Grades"})]})}),r==="students"&&e.jsx(ke,{size:"small",fullWidth:!0,options:X,noOptionsText:"No Level available",getOptionLabel:a=>a.type||"",isOptionEqualToValue:(a,n)=>n._id===void 0||n._id===""||n._id===a._id,value:y,onChange:(a,n)=>G(n),renderInput:a=>{var n,u,m,g;return e.jsx(b,{fullWidth:!0,...a,label:"Select Level",size:"small",error:!!((n=s.levelValue)!=null&&n._id&&((u=t.levelValue)!=null&&u._id)),helperText:((m=s.levelValue)==null?void 0:m._id)&&((g=t.levelValue)==null?void 0:g._id),required:!0,FormHelperTextProps:{sx:{color:"error.main"}}})}}),["students","teachers"].includes(r)&&e.jsxs(b,{label:"Choose Data Type to Upload",select:!0,fullWidth:!0,size:"small",value:o,onChange:a=>M(a.target.value),error:!!(s.dataType&&t.dataType),helperText:s.dataType&&t.dataType,children:[e.jsx(j,{value:"personal-data",children:"Personal Data"}),e.jsx(j,{value:"photos",children:"Photos"})]}),r==="grades"&&e.jsx(b,{label:"Name of Grade System",fullWidth:!0,size:"small",value:_,onChange:a=>W(a.target.value),error:!!(s.gradeName&&t.gradeName),helperText:s.gradeName&&t.gradeName})]}),e.jsxs(Ae,{sx:{cursor:"pointer",display:"block"},onClick:re,variant:"caption",children:["Download ",r," template here"]})]}),e.jsx(A,{pt:2,children:e.jsxs(v,{border:"1px dotted #333",p:2,...q({className:"dropzone"}),justifyContent:"center",alignItems:"center",children:[e.jsx("input",{...$()}),U===w?e.jsx("img",{alt:"csv file",src:B.csv,style:{width:48,height:48}}):[z,V].includes(U)?e.jsx("img",{alt:"excel file",src:B.excel,style:{width:48,height:48}}):e.jsx(je,{sx:{width:36,height:36,alignSelf:"center"}}),e.jsxs(E,{variant:"body2",textAlign:"center",pt:4,paragraph:!0,children:["Drag & drop your"," ",o==="personal-data"?"data File":"photos"," ","here"]}),e.jsxs(L,{variant:"outlined",onClick:J,startIcon:o==="personal-data"?e.jsx(Be,{}):e.jsx(Ee,{}),children:["Upload"," ",o==="personal-data"?"File":"Photos"]})]})})]})]}),(l==null?void 0:l.length)>0&&e.jsxs(v,{direction:"row",justifyContent:"flex-start",width:"100%",gap:2,children:[e.jsx(L,{onClick:oe,children:"Cancel"}),e.jsx(L,{variant:"contained",onClick:i,children:"Import Data"})]})]})}),e.jsxs(e.Fragment,{children:[N&&e.jsx(ye,{sx:{color:"red"},children:N}),o==="personal-data"?e.jsx(be,{icon:Le.score,search:!0,title:P.upperCase(r),columns:ne,data:l,actions:[]}):e.jsx(A,{sx:{display:"flex",flexWrap:"wrap",gap:2,py:4,width:"100%"},children:l==null?void 0:l.map(t=>e.jsxs(v,{border:"1px solid #ccc",alignItems:"center",p:1,spacing:1,children:[e.jsx("img",{src:t==null?void 0:t.src,style:{width:100,height:100}}),e.jsx(E,{children:t==null?void 0:t.id})]},t==null?void 0:t.id))})]}),(ae||Y)&&e.jsx(Ce,{value:"Please Wait.."})]})};export{St as default};
