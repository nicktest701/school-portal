import{r as i,S as D,a1 as Q,a as Y,u as z,i as G,b as H,n as O,c as U,d as W,j as e,e as $,k as b,l as K,T as J,B as y,z as Z,P as ee,a9 as te,H as se,_ as re,f as oe,g as ae,h as ne,aI as ie}from"./index-B8PQHtjc.js";import{C as le,f as ce,g as ue}from"./CustomizedMaterialTable-BQoTtwVw.js";import{E as me}from"./images-B5fNBSni.js";import{a as de}from"./ExaminationAPI-gfcTwHm9.js";import{g as pe}from"./generateCustomGrade-DQ-rrl9K.js";import{B as xe}from"./Back-D8wcFeGb.js";import{A as fe}from"./Autocomplete-Dw57Ihk7.js";import{N as he}from"./NoteRounded-DYrWuwPi.js";import"./TabPanel-WHfZdNAn.js";import"./useThemeProps-CEPKeDia.js";import"./Toolbar-YM__bEFh.js";import"./Chip-DmEpgF7y.js";import"./Skeleton-DWRiBFRT.js";import"./ButtonGroup-ZC3qSltg.js";import"./ListItemText-DzMM1D1F.js";import"./InputAdornment-DAOlZ4uj.js";import"./index-BqG4A_N5.js";import"./DialogActions-BmNk8sop.js";import"./ListItem-CQImyTSy.js";import"./ListItemSecondaryAction-DOVMjMKm.js";import"./listItemButtonClasses-DySKLRoc.js";import"./Grid2-B2FVLpOz.js";import"./Link-kLE4_HTq.js";import"./ListItemButton-Di0YOqWQ.js";import"./Check-JB41DPzl.js";import"./DeleteOutline-BlPFLwFk.js";const Ye=()=>{var T;const E="text/csv",w="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",B="application/vnd.ms-excel",{schoolSessionDispatch:C}=i.useContext(D),{userState:{session:l}}=i.useContext(Q),[c]=Y(),N=z(),{levelId:d}=G(),F=H(),{state:u}=O(),[r,f]=i.useState([]),[h,m]=i.useState(!1),[I,v]=i.useState(""),[P,S]=i.useState(""),[o,R]=i.useState(c.get("sub")),a=U({queryKey:["subjects",d],queryFn:()=>ie(d),enabled:!!d,select:({subjects:t,grades:s})=>({subjects:t,grades:s})});i.useEffect(()=>{if((r==null?void 0:r.length)>0){const t=r==null?void 0:r.map(s=>({...s,subject:o}));f(t)}},[o]);function _(t){if(o===""){v("Please select a Subject!"),m(!1);return}S(!1),m(!0);const s=t.target.files[0];try{const n=new FileReader;s.type===E?n.readAsBinaryString(s):n.readAsArrayBuffer(s),n.onload=async function(L){let p=[];if((s.type===w||s.type===B)&&(p=ce(L.target.result)),s.type===E&&(p=ue(L.target.result)),p.length!==0){const q=p.map(x=>{var k;const g=Number(Object.values(x)[2]||0),j=Number(Object.values(x)[3]||0);if(g>50||j>50)throw S("It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50 marks!"),m(!1),f([]),"It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50";return{indexnumber:re.toString(Object.values(x)[0]),student:Object.values(x)[1],subject:o,classScore:g,examsScore:j,...pe(+g+ +j,(k=a==null?void 0:a.data)==null?void 0:k.grades)}}),V=await Promise.all(q);f(V)}}}catch(n){S(n)}finally{m(!1)}}const{mutateAsync:A}=W({mutationFn:de}),M=()=>{v(""),oe.fire({title:"Importing results",text:`Do you want to import results in ${o}?`,showCancelButton:!0}).then(({isConfirmed:t})=>{if(t){m(!0);const s={session:l==null?void 0:l.sessionId,term:l==null?void 0:l.termId,level:d,results:r};A(s,{onSettled:()=>{F.invalidateQueries(["all-results"]),F.invalidateQueries(["subject-score",d,c.get("sub")]),m(!1)},onSuccess:n=>{C(ae(n)),N(u==null?void 0:u.prevPath)},onError:n=>{C(ne(n))}})}})},X=[{title:"Index Number",field:"indexnumber"},{title:"Student",field:"student"},{title:"Subject",field:"subject",hidden:o||c.get("sub")},{title:"Class Score(50%)",field:"classScore"},{title:"Exams Score(50%)",field:"examsScore"},{title:"Total Score(100%)",field:"totalScore"},{title:"Grade",field:"grade"},{title:"Remarks",field:"remarks"}];return e.jsxs(e.Fragment,{children:[e.jsx(xe,{to:u==null?void 0:u.prevPath,color:"primary.main"}),e.jsx($,{title:"Exams Scores",subtitle:"Import Student exams results from excel or csv files.",color:"primary.main"}),e.jsxs(b,{spacing:2,py:4,px:2,my:4,border:"1px solid lightgray",children:[e.jsxs(K,{children:["Select an ",e.jsx("b",{children:"EXCEL"})," OR ",e.jsx("b",{children:"CSV"})," file containing student results information. Make sure the columns matches the accepted fields."]}),e.jsxs(b,{direction:"row",spacing:3,pt:2,children:[e.jsx(fe,{options:c.get("sub")!==null?[c.get("sub")]:(T=a==null?void 0:a.data)==null?void 0:T.subjects,loading:a==null?void 0:a.isPending,getOptionLabel:t=>t||"",isOptionEqualToValue:(t,s)=>s===void 0||s===""||s===t,defaultValue:c.get("sub"),value:o,onChange:(t,s)=>R(s),sx:{minWidth:300},renderInput:t=>e.jsx(J,{...t,label:"Select Subject",size:"small",error:I!=="",helperText:I,required:!0,FormHelperTextProps:{sx:{color:"error.main"}}})}),e.jsxs(y,{variant:"contained",sx:{width:300,cursor:"pointer"},startIcon:e.jsx(he,{}),children:[e.jsx("label",{style:{color:"#fff"},htmlFor:"resultFile",title:"Import results",children:h?"Please Wait...":"Upload File"}),e.jsx(Z,{type:"file",id:"resultFile",name:"resultFile",hidden:!0,inputProps:{accept:".xlsx,.xls,.csv"},onChange:t=>_(t),onClick:t=>{t.target.value=null,t.currentTarget.value=null}})]})]})]}),e.jsx(ee,{children:e.jsxs(e.Fragment,{children:[P&&e.jsx(te,{sx:{color:"red"},children:P}),e.jsx(le,{icon:me.score,search:!0,exportFileName:`${o} - `,isPending:h,title:o,columns:X,data:r,actions:[],autoCompleteComponent:e.jsx(e.Fragment,{children:(r==null?void 0:r.length)>0&&e.jsxs(b,{direction:"row",spacing:3,justifyContent:"flex-end",children:[e.jsx(y,{children:"Cancel"}),e.jsx(y,{variant:"contained",onClick:M,children:"Save Results"})]})})})]})}),h&&e.jsx(se,{})]})};export{Ye as default};
