import{r as i,S as Q,a0 as V,a as Y,u as G,i as z,b as H,n as O,c as U,d as W,j as e,e as $,k as j,l as K,T as J,B as k,aD as Z,M as ee,a8 as te,y as se,Q as re,_ as oe,f as ae,g as ne,h as ie,am as le}from"./index-DrgqF6h7.js";import{C as ce,r as ue,b as me}from"./CustomizedMaterialTable-sErZg5Gy.js";import{E as de}from"./images-B5fNBSni.js";import{b as pe}from"./ExaminationAPI-CMjpI3MV.js";import{g as xe}from"./generateCustomGrade-DQ-rrl9K.js";import{B as fe}from"./Back-CADpxW16.js";import{A as he}from"./Autocomplete-D4vPEd6T.js";import{N as Se}from"./NoteRounded-C-aYX6gh.js";import"./TabPanel-Bl8roboH.js";import"./useThemeProps-DLRF2U3R.js";import"./Toolbar-Bzx_LBRC.js";import"./Chip-BcLQNplL.js";import"./Skeleton-BUD-o5ar.js";import"./ButtonGroup-DQMwsk7A.js";import"./ListItemText-Bwh_rzOL.js";import"./InputAdornment-EcTjtcuD.js";import"./index-_n9xtSlI.js";import"./DialogActions-Cx2GHHEW.js";import"./ListItem-yCsexoBs.js";import"./ListItemSecondaryAction-mmiMbVqP.js";import"./listItemButtonClasses-CLhmtlXH.js";import"./ListItemButton-BUsfko6u.js";import"./Check-CEGAxChF.js";import"./DeleteOutline-DM92K-00.js";const Ve=()=>{var L;const y="text/csv",B="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",w="application/vnd.ms-excel",{schoolSessionDispatch:E}=i.useContext(Q),{userState:{session:l}}=i.useContext(V),[c]=Y(),N=G(),{levelId:d}=z(),C=H(),{state:u}=O(),[r,f]=i.useState([]),[h,m]=i.useState(!1),[F,v]=i.useState(""),[I,S]=i.useState(""),[o,R]=i.useState(c.get("sub")),a=U({queryKey:["subjects",d],queryFn:()=>le(d),enabled:!!d,select:({subjects:t,grades:s})=>({subjects:t,grades:s})});i.useEffect(()=>{if((r==null?void 0:r.length)>0){const t=r==null?void 0:r.map(s=>({...s,subject:o}));f(t)}},[o]);function _(t){if(o===""){v("Please select a Subject!"),m(!1);return}S(!1),m(!0);const s=t.target.files[0];try{const n=new FileReader;s.type===y?n.readAsBinaryString(s):n.readAsArrayBuffer(s),n.onload=async function(P){let p=[];if((s.type===B||s.type===w)&&(p=ue(P.target.result)),s.type===y&&(p=me(P.target.result)),p.length!==0){const q=p.map(x=>{var T;const g=Number(Object.values(x)[2]||0),b=Number(Object.values(x)[3]||0);if(g>50||b>50)throw S("It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50 marks!"),m(!1),f([]),"It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50";return{indexnumber:oe.toString(Object.values(x)[0]),student:Object.values(x)[1],subject:o,classScore:g,examsScore:b,...xe(+g+ +b,(T=a==null?void 0:a.data)==null?void 0:T.grades)}}),D=await Promise.all(q);f(D)}}}catch(n){S(n)}finally{m(!1)}}const{mutateAsync:A}=W({mutationFn:pe}),M=()=>{v(""),ae.fire({title:"Importing results",text:`Do you want to import results in ${o}?`,showCancelButton:!0}).then(({isConfirmed:t})=>{if(t){m(!0);const s={session:l==null?void 0:l.sessionId,term:l==null?void 0:l.termId,level:d,results:r};A(s,{onSettled:()=>{C.invalidateQueries(["all-results"]),C.invalidateQueries(["subject-score",d,c.get("sub")]),m(!1)},onSuccess:n=>{E(ne(n)),N(u==null?void 0:u.prevPath)},onError:n=>{E(ie(n))}})}})},X=[{title:"Index Number",field:"indexnumber"},{title:"Student",field:"student"},{title:"Subject",field:"subject",hidden:o||c.get("sub")},{title:"Class Score(50%)",field:"classScore"},{title:"Exams Score(50%)",field:"examsScore"},{title:"Total Score(100%)",field:"totalScore"},{title:"Grade",field:"grade"},{title:"Remarks",field:"remarks"}];return e.jsxs(e.Fragment,{children:[e.jsx(fe,{to:u==null?void 0:u.prevPath,color:"primary.main"}),e.jsx($,{title:"Exams Scores",subtitle:"Import Student exams results from excel or csv files.",color:"primary.main"}),e.jsxs(j,{spacing:2,py:4,px:2,my:4,border:"1px solid lightgray",children:[e.jsxs(K,{children:["Select an ",e.jsx("b",{children:"EXCEL"})," OR ",e.jsx("b",{children:"CSV"})," file containing student results information. Make sure the columns matches the accepted fields."]}),e.jsxs(j,{direction:"row",spacing:3,pt:2,children:[e.jsx(he,{options:c.get("sub")!==null?[c.get("sub")]:(L=a==null?void 0:a.data)==null?void 0:L.subjects,loading:a==null?void 0:a.isLoading,getOptionLabel:t=>t||"",isOptionEqualToValue:(t,s)=>s===void 0||s===""||s===t,defaultValue:c.get("sub"),value:o,onChange:(t,s)=>R(s),sx:{minWidth:300},renderInput:t=>e.jsx(J,{...t,label:"Select Subject",size:"small",error:F!=="",helperText:F,required:!0,FormHelperTextProps:{sx:{color:"error.main"}}})}),e.jsxs(k,{variant:"contained",sx:{width:300,cursor:"pointer"},startIcon:e.jsx(Se,{}),children:[e.jsx("label",{style:{color:"#fff"},htmlFor:"resultFile",title:"Import results",children:h?"Please Wait...":"Upload File"}),e.jsx(Z,{type:"file",id:"resultFile",name:"resultFile",hidden:!0,inputProps:{accept:".xlsx,.xls,.csv"},onChange:t=>_(t),onClick:t=>{t.target.value=null,t.currentTarget.value=null}})]})]})]}),e.jsx(ee,{children:e.jsxs(e.Fragment,{children:[I&&e.jsx(te,{sx:{color:"red"},children:I}),e.jsx(ce,{icon:de.score,search:!0,exportFileName:`${o} - `,isLoading:h,title:o,columns:X,data:r,actions:[],autoCompleteComponent:e.jsx(e.Fragment,{children:(r==null?void 0:r.length)>0&&e.jsxs(j,{direction:"row",spacing:3,justifyContent:"flex-end",children:[e.jsx(k,{children:"Cancel"}),e.jsx(se,{variant:"contained",onClick:M,children:"Save Results"})]})})})]})}),h&&e.jsx(re,{})]})};export{Ve as default};
