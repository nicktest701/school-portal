import{au as xe,j as e,D,r,a0 as ee,g as P,f as R,v as H,_ as v,i as Y,k as G,l as te,n as se,av as pe,z as ne,m as Q,S as T,b as B,B as V,L as $,T as S,a6 as ae,p as ie,q as le,s as oe,t as re,ag as ue,aw as fe,x as je}from"./index-bb65b4bf.js";import{g as de,p as he,a as ge,d as ye}from"./feeAPI-18dfe0ab.js";import{L as ve,C as Se}from"./CustomizedMaterialTable-266061d1.js";import{F as me,d as Ce}from"./sessionColumns-3b88387c.js";import{c as L}from"./currencyFormatter-1910a788.js";import{L as Fe}from"./ListItem-befde9c4.js";import{L as X}from"./ListItemText-33ae0292.js";import{L as be}from"./ListItemSecondaryAction-c66bb893.js";import{u as Ae}from"./useLevel-2a56aacb.js";import{A as I}from"./Autocomplete-95da27f3.js";import{I as M}from"./InputAdornment-321f8206.js";import{E as Le}from"./images-0c291668.js";import{b as Te}from"./currentFeeAPI-3305f0eb.js";import{f as Z}from"./fee_ico-578bcc38.js";import{C as Ee}from"./CustomTitle-ed47c53b.js";import"./TabPanel-175e39ff.js";import"./Toolbar-36d77a55.js";import"./MenuItem-1edcf8db.js";import"./listItemTextClasses-35ff90f6.js";import"./Chip-fa36c3a1.js";import"./Skeleton-6cff8ea8.js";import"./ButtonGroup-83f2640f.js";import"./CardContent-25ef3451.js";import"./Grid-6a14669c.js";import"./useMediaQuery-5f0ec7e9.js";import"./ListItemButton-bf3e0355.js";import"./listItemButtonClasses-9702db06.js";import"./Check-7b95876f.js";import"./DeleteOutline-80e9f63f.js";import"./Delete-97505065.js";import"./Add-66663708.js";import"./CircleRounded-3db5a545.js";import"./Edit-11e1ba9f.js";import"./score_ico-e1082ac1.js";const we=xe(),Be=we,ce=({data:t,removeFee:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(Fe,{children:[e.jsx(X,{secondary:t==null?void 0:t.fee}),e.jsx(X,{secondary:L(t.amount)}),e.jsx(be,{children:e.jsx(ve,{size:"small",sx:{cursor:"pointer"},onClick:()=>a(t==null?void 0:t.fee),children:"Remove"})})]}),e.jsx(D,{})]}),Ne=({open:t,setOpen:a})=>{const{userState:{session:l}}=r.useContext(ee),h=P(),{schoolSessionDispatch:g}=r.useContext(R),[m,C]=r.useState({_id:"",type:""}),[y,F]=r.useState(""),[u,c]=r.useState(""),[x,b]=r.useState([]),[f,A]=r.useState(0),[N,E]=r.useState({severity:"",text:""}),{levelsOption:_}=Ae();H(["fees"],()=>de(l),{enabled:!!(l!=null&&l.sessionId),onSuccess:s=>F(s)});const W={level:m,fee:x},i=()=>{u===""||f===""||(b(s=>s!==void 0?v.values(v.merge(v.keyBy([...s,{fee:u,amount:Number(f)}],"fee"))):[{fee:u,amount:Number(f)}]),c(""),A(""))},d=s=>{b(n=>n.filter(({fee:k})=>k!==s))},q=r.useMemo(()=>L(v.sumBy(x,"amount")),[x]),{mutateAsync:O}=Y(he),z=(s,n)=>{E({text:""});const j={session:l.sessionId,term:l.termId,level:s.level._id,levelType:s.level.type,amount:s.fee},k=y.find(({_id:o})=>o===j.level);if(!v.isEmpty(k)){E({severity:"error",text:`Fees for ${j.levelType} already exists.Please try updating it.`});return}O(j,{onSettled:()=>{h.invalidateQueries(["fees"]),n.setSubmitting(!1)},onSuccess:o=>{g(oe(o)),a(!1)},onError:o=>{g(re(o))}})};return e.jsxs(G,{open:t,onClose:()=>a(!1),fullWidth:!0,maxWidth:"xs",children:[e.jsx(te,{title:"New Fees",onClose:()=>a(!1)}),e.jsx(se,{initialValues:W,onSubmit:z,validationSchema:pe,enableReinitialize:!0,children:({errors:s,touched:n,handleSubmit:j,isSubmitting:k})=>e.jsxs(e.Fragment,{children:[N.text&&e.jsx(ne,{sx:{marginY:1},severity:N.severity,onClose:()=>E({text:""}),children:N.text}),e.jsx(Q,{children:e.jsxs(T,{spacing:2,paddingY:2,children:[e.jsx(I,{fullWidth:!0,options:_,isOptionEqualToValue:(o,p)=>p._id===void 0||p._id===""||o._id===p._id,getOptionLabel:o=>o.type||"",value:m,onChange:(o,p)=>C(p),renderInput:o=>{var p,K,U,J;return e.jsx(B,{...o,label:"Select Level",size:"small",error:!!((p=n==null?void 0:n.level)!=null&&p.type&&((K=s==null?void 0:s.level)!=null&&K.type)),helperText:((U=n==null?void 0:n.level)==null?void 0:U.type)&&((J=s==null?void 0:s.level)==null?void 0:J.type)})}}),e.jsx(I,{freeSolo:!0,fullWidth:!0,options:me,isOptionEqualToValue:(o,p)=>p===void 0||p===""||o===p,getOptionLabel:o=>o||"",value:u,onInputChange:(o,p)=>c(p),renderInput:o=>e.jsx(B,{...o,label:"Select Fee Type",size:"small",error:!!(n!=null&&n.fee&&(s!=null&&s.fee)),helperText:(n==null?void 0:n.fee)&&(s==null?void 0:s.fee)&&"Enter a least one fee type*"})}),e.jsx(B,{type:"number",label:"Enter Fee Amount",size:"small",InputProps:{startAdornment:e.jsx(M,{position:"start",children:"GHS"}),endAdornment:e.jsx(M,{position:"end",children:"p"})},value:f,onChange:o=>A(o.target.value),error:!!(n!=null&&n.fee&&(s!=null&&s.fee)),helperText:(n==null?void 0:n.fee)&&(s==null?void 0:s.fee)&&"Required*"}),e.jsx(V,{variant:"contained",size:"small",onClick:i,children:"Add"}),e.jsxs($,{sx:{maxHeight:400},children:[e.jsx(S,{variant:"body1",sx:{fontWeight:"bold"},children:"Fees"}),v.isEmpty(x)?e.jsx(S,{children:"No Fee Available"}):x.map(o=>e.jsx(ce,{data:o,removeFee:d},o.fee)),e.jsx(D,{}),e.jsxs(T,{direction:"row",justifyContent:"space-between",children:[e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:"Total Fees"}),e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:q})]})]}),s.fee&&e.jsx(ae,{sx:{color:"error.main"},children:s.fee})]})}),e.jsx(ie,{sx:{padding:2},children:e.jsx(le,{loading:k,variant:"contained",onClick:j,children:"Save"})})]})})]})},Oe=()=>{var _,W;const t=P(),{schoolSessionState:{feeEditData:a},schoolSessionDispatch:l}=r.useContext(R),[h,g]=r.useState(""),[m,C]=r.useState([]),[y,F]=r.useState(0),[u,c]=r.useState({severity:"",text:""});r.useEffect(()=>{var i;C((i=a==null?void 0:a.data)==null?void 0:i.amount)},[a]);const x=()=>{h===""||y===""||(C(i=>i!==void 0?v.values(v.merge(v.keyBy([...i,{fee:h,amount:Number(y)}],"fee"))):[{fee:h,amount:Number(y)}]),g(""),F(""))},b=i=>{C(d=>d.filter(({fee:O})=>O!==i))},f=r.useMemo(()=>L(v.sumBy(m,"amount")),[m]),{mutateAsync:A}=Y(ge),N=(i,d)=>{c({text:""}),A({_id:i._id,amount:i.fee},{onSettled:()=>{t.invalidateQueries(["fees"]),d.setSubmitting(!1)},onSuccess:()=>{c({severity:"info",text:"Changes Saved!!!"})}})},E=()=>{l({type:"setFeeEditData",payload:{open:!1,data:{}}})};return e.jsxs(G,{open:a.open,onClose:E,fullWidth:!0,maxWidth:"xs",TransitionComponent:ue,children:[e.jsx(fe,{children:"Edit Fees"}),e.jsx(se,{initialValues:{_id:(_=a==null?void 0:a.data)==null?void 0:_._id,level:(W=a==null?void 0:a.data)==null?void 0:W.level,fee:m},onSubmit:N,enableReinitialize:!0,children:({errors:i,touched:d,handleSubmit:q,isSubmitting:O})=>{var z,s;return e.jsxs(e.Fragment,{children:[u.text&&e.jsx(ne,{sx:{marginY:1},severity:u.severity,onClose:()=>c({text:""}),children:u.text}),e.jsx(Q,{children:e.jsxs(T,{spacing:2,paddingY:2,children:[e.jsx(B,{label:" Level",size:"small",InputProps:{readOnly:!0},value:((z=a==null?void 0:a.data)==null?void 0:z.level)!==void 0?(s=a==null?void 0:a.data)==null?void 0:s.level:""}),e.jsx(I,{freeSolo:!0,fullWidth:!0,options:me,isOptionEqualToValue:(n,j)=>j===void 0||j===""||n===j,getOptionLabel:n=>n||"",value:h,onInputChange:(n,j)=>g(j),renderInput:n=>e.jsx(B,{...n,label:"Select Fee Type",size:"small",error:!!(d!=null&&d.fee&&(i!=null&&i.fee)),helperText:(d==null?void 0:d.fee)&&(i==null?void 0:i.fee)&&"Enter a least one fee type*"})}),e.jsx(B,{type:"number",label:"Enter Fee Amount",size:"small",InputProps:{startAdornment:e.jsx(M,{position:"start",children:"GHS"}),endAdornment:e.jsx(M,{position:"end",children:"p"})},value:y,onChange:n=>F(n.target.value),error:!!(d!=null&&d.fee&&(i!=null&&i.fee)),helperText:(d==null?void 0:d.fee)&&(i==null?void 0:i.fee)&&"Required*"}),e.jsx(V,{variant:"contained",size:"small",onClick:x,children:"Add"}),e.jsxs($,{sx:{maxHeight:400},children:[e.jsx(S,{variant:"body1",sx:{fontWeight:"bold"},children:"Fees"}),v.isEmpty(m)?e.jsx(S,{children:"No Fee Available"}):m.map(n=>e.jsx(ce,{data:n,removeFee:b},n.fee)),e.jsx(D,{}),e.jsxs(T,{direction:"row",justifyContent:"space-between",children:[e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:"Total Fees"}),e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:f})]})]}),i.fee&&e.jsx(ae,{sx:{color:"error.main"},children:i.fee})]})}),e.jsxs(ie,{sx:{padding:2},children:[e.jsx(V,{onClick:E,children:"Cancel"}),e.jsx(le,{loading:O,variant:"contained",onClick:q,children:"Save Changes"})]})]})}})]})};function w({title:t,value:a}){return e.jsxs(Be,{children:[e.jsx(S,{variant:"caption",color:"primary",children:t}),e.jsx(S,{variant:"body2",children:a})]})}function ke(){var g,m,C,y,F,u,c,x,b;const{schoolSessionState:{levelFeeInfo:t},schoolSessionDispatch:a}=r.useContext(R);console.log(t);const l=H({queryKey:["level-fee",t.data],queryFn:()=>Te(t==null?void 0:t.data),enabled:!!((g=t==null?void 0:t.data)!=null&&g.term)&&!!((m=t==null?void 0:t.data)!=null&&m.level),onSuccess:f=>{console.log(f)}}),h=()=>{a({type:"viewLevelFeeInfo",payload:{open:!1,data:{}}})};return e.jsxs(G,{open:t.open,fullWidth:!0,maxWidth:"xs",onClose:h,children:[e.jsx(te,{title:"School Fees Details",onClose:h}),e.jsxs(Q,{children:[(l==null?void 0:l.isLoading)&&e.jsx(S,{children:"Loading....."}),(l==null?void 0:l.data)!==void 0&&e.jsxs(T,{rowGap:2,children:[e.jsx(w,{title:"Level",value:(C=t==null?void 0:t.data)==null?void 0:C.levelName}),e.jsxs(T,{direction:"row",columnGap:2,children:[e.jsx(w,{title:" Total Fee",value:L((y=t==null?void 0:t.data)==null?void 0:y.fee)}),e.jsx($,{children:t.data.amount&&t.data.amount.map(({fee:f,amount:A})=>e.jsxs(T,{paddingY:1,children:[e.jsx("small",{style:{color:"#00f"},children:f}),e.jsx("small",{children:L(A)})]},f))})]}),e.jsx(w,{title:"Number of Students",value:(F=t==null?void 0:t.data)==null?void 0:F.noOfStudents}),e.jsx(w,{title:"Total Expected Amount of Fees",value:L(((u=t==null?void 0:t.data)==null?void 0:u.fee)*((c=t==null?void 0:t.data)==null?void 0:c.noOfStudents))}),e.jsx(w,{title:"Total Amount of Fees Paid",value:L(l==null?void 0:l.data)}),e.jsx(w,{title:"Total Outstanding Fees",value:L(Number(((x=t==null?void 0:t.data)==null?void 0:x.fee)*((b=t==null?void 0:t.data)==null?void 0:b.noOfStudents))-Number(l==null?void 0:l.data))})]})]})]})}const ut=()=>{const{userState:{session:t}}=r.useContext(ee),a=P(),{schoolSessionDispatch:l}=r.useContext(R),[h,g]=r.useState(!1),m=H({queryKey:["fees"],queryFn:()=>de(t),enabled:!!(t!=null&&t.sessionId)}),{mutateAsync:C}=Y(ye),y=c=>{je.fire({title:"Removing",text:"Do you want to remove Fee?",showCancelButton:!0}).then(({isConfirmed:x})=>{x&&C(c,{onSettled:()=>{a.invalidateQueries(["fees"])},onSuccess:()=>{l(oe("Fee has been removed successfully!!!"))},onError:()=>{l(re("Error removing Fee!!!"))}})})},F=c=>{l({type:"setFeeEditData",payload:{open:!0,data:c}})},u=({levelId:c,level:x,fee:b,noOfStudents:f,amount:A})=>{l({type:"viewLevelFeeInfo",payload:{open:!0,data:{noOfStudents:f,fee:b,level:c,levelName:x,term:t.termId,amount:A}}})};return e.jsxs(e.Fragment,{children:[e.jsxs(e.Fragment,{children:[e.jsx(Ee,{title:"New Fee",subtitle:"Add new TERM/SEMESTER fees for a particular level",img:Z,color:"primary.main"}),e.jsx(Se,{title:"School Fees",icon:Z,columns:Ce(u,F,y),data:m.data?m.data:[],isLoading:m.isLoading,actions:[],search:!0,showAddButton:!0,addButtonText:"New Fee",addButtonImg:Le.sms,addButtonMessage:"😑 No School Fees available!.Create a new one",onAddButtonClicked:()=>g(!0)})]}),e.jsx(Ne,{open:h,setOpen:g}),e.jsx(Oe,{}),e.jsx(ke,{})]})};export{ut as default};
