import{O as he,j as e,P as $,Q,R as q,r as i,U as L,a0 as ye,g as D,_ as m,i as ge,y as je,C as be,l as fe,$ as Se,aW as ve,m as d,q as o,b as h,G as Ce,M as Fe,a6 as Pe,S as _e,an as Te,u as Ae,bT as we,h as Me,bU as Oe,E as De,J as He,n as W,T as b,B as G,a3 as O,bV as Ie,D as P,V as Ne,I as Y,v as Ee,bW as Be,av as ke,bX as ze,A as Re,ap as qe,K as We,w as Ge,x as Ye}from"./index-5b8f5a53.js";import{f as V,b as Ve}from"./fee_ico-279f75d1.js";import{c as $e,d as Qe,p as Le}from"./currentFeeAPI-5ac33c46.js";import{S as Ke}from"./StudentFeesHistory-6ba29bb4.js";const Ue=he(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16"}),"MonetizationOn");var H={},Je=Q;Object.defineProperty(H,"__esModule",{value:!0});var K=H.default=void 0,Xe=Je($()),Ze=e;K=H.default=(0,Xe.default)((0,Ze.jsx)("path",{d:"M13.26 3C8.17 2.86 4 6.95 4 12H2.21c-.45 0-.67.54-.35.85l2.79 2.8c.2.2.51.2.71 0l2.79-2.8c.31-.31.09-.85-.36-.85H6c0-3.9 3.18-7.05 7.1-7 3.72.05 6.85 3.18 6.9 6.9.05 3.91-3.1 7.1-7 7.1-1.61 0-3.1-.55-4.28-1.48-.4-.31-.96-.28-1.32.08-.42.42-.39 1.13.08 1.49C9 20.29 10.91 21 13 21c5.05 0 9.14-4.17 9-9.26-.13-4.69-4.05-8.61-8.74-8.74m-.51 5c-.41 0-.75.34-.75.75v3.68c0 .35.19.68.49.86l3.12 1.85c.36.21.82.09 1.03-.26.21-.36.09-.82-.26-1.03l-2.88-1.71v-3.4c0-.4-.34-.74-.75-.74"}),"HistoryRounded");var I={},et=Q;Object.defineProperty(I,"__esModule",{value:!0});var U=I.default=void 0,tt=et($()),st=e;U=I.default=(0,tt.default)((0,st.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1.41 16.09v.58c0 .73-.6 1.33-1.33 1.33h-.01c-.73 0-1.33-.6-1.33-1.33v-.6c-1.33-.28-2.51-1.01-3.01-2.24-.23-.55.2-1.16.8-1.16h.24c.37 0 .67.25.81.6.29.75 1.05 1.27 2.51 1.27 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21v-.6c0-.73.6-1.33 1.33-1.33h.01c.73 0 1.33.6 1.33 1.33v.62c1.38.34 2.25 1.2 2.63 2.26.2.55-.22 1.13-.81 1.13h-.26c-.37 0-.67-.26-.77-.62-.23-.76-.86-1.25-2.12-1.25-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.02 1.83-1.39 2.83-3.13 3.16"}),"MonetizationOnRounded");function J({open:_,setOpen:u}){const{userState:{session:l}}=i.useContext(L),[c,r]=i.useState(ye()),[f,T]=i.useState(0),y=D({queryKey:["fees-for-day",c],queryFn:()=>$e({session:l==null?void 0:l.sessionId,term:l==null?void 0:l.termId,date:c}),enabled:!!(l!=null&&l.sessionId)&&!!(l!=null&&l.termId)&&!!c,onSuccess:g=>{T(m.sumBy(m.flatMap(g,"payment"),"paid"))}}),p=()=>u(!1);return e.jsxs(ge,{fullWidth:!0,maxWidth:"md",open:_,onClose:p,TransitionComponent:je,children:[e.jsx(be,{title:"Fee Payment History",onClose:p}),e.jsxs(fe,{children:[e.jsx(Se,{width:300,paddingY:1,children:e.jsx(ve,{label:"Date Of Payment",date:c,setDate:r})}),e.jsxs(d,{children:[e.jsx(o,{textAlign:"right",children:"Total Amount"}),e.jsx(o,{textAlign:"right",variant:"h5",children:h(f)})]}),e.jsx(Ce,{isLoading:y.isLoading,icon:V,title:`Fee Payment on ${c.format("LL")}`,addButtonImg:V,addButtonMessage:"Payment not available",handleRefresh:y.refetch,columns:[{title:"Student",field:"student"},{title:"Level",field:"level"},{title:"Amount Paid",field:"payment",render:({payment:g})=>e.jsx(e.Fragment,{children:g.map(S=>e.jsx(d,{direction:"row",columnGap:1,children:e.jsx(o,{variant:"caption",children:h(S.paid)})},S.date))})}],data:y.data,actions:[]})]})]})}J.propTypes={open:q.bool,setOpen:q.func};const ot=()=>{const _=Fe(),[u,l]=Pe(),{user:c,userState:{session:r}}=i.useContext(L),{schoolSessionDispatch:f}=i.useContext(_e),{studentDispatch:T}=i.useContext(Te),y=Ae(),[p,g]=i.useState({severity:"",text:""}),[S,N]=i.useState(!1),[X,E]=i.useState(!1),[t,B]=i.useState({_id:"",fullName:"",profile:""}),[a,Z]=i.useState({levelId:"",levelType:"",feesId:"",fees:0}),[k,ee]=i.useState(0),[A,te]=i.useState(0),[w,se]=i.useState(0),[z,ne]=i.useState(0),[v,ae]=i.useState(0),x=D({queryKey:["all-level-fees",r.sessionId,r.termId],queryFn:()=>Ve({session:r.sessionId,term:r.termId}),enabled:!!(r!=null&&r.sessionId)&&!!(r!=null&&r.termId)}),{students:R,levelLoading:ie}=we(a==null?void 0:a.levelId);D(["student-fees",t==null?void 0:t._id,u.get("level_id")],()=>Qe({session:r.sessionId,term:r.termId,student:t==null?void 0:t._id,level:u.get("level_id")}),{enabled:!!(t!=null&&t._id)&&!!u.get("level_id"),onSuccess:s=>{var n;ne(s==null?void 0:s.totalAmountPaid),se(s==null?void 0:s.totalArreas),te(((n=s==null?void 0:s.current)==null?void 0:n.amountPaid)||0),ee(s==null?void 0:s.totalFees)}});const M=i.useMemo(()=>(a==null?void 0:a.fees)+w,[w,a==null?void 0:a.fees]),C=i.useMemo(()=>M-A,[A,M]),re=i.useMemo(()=>{const s=k-(z+Number(v));return s<0?{date:new Date().toISOString(),paid:C,outstanding:0,balance:Math.abs(s),issuer:c==null?void 0:c.fullname}:{date:new Date().toISOString(),paid:v,outstanding:s,balance:0,issuer:c==null?void 0:c.fullname}},[v,C,z,k]),{mutateAsync:oe,isLoading:le}=Me({mutationFn:Le});function de(s,n){g({severity:"info",text:""});const j={session:r.sessionId,term:r.termId,level:a.levelId,student:t==null?void 0:t._id,fee:a==null?void 0:a.feesId,payment:[re]};We.fire({title:"Making Payment",text:"Do you want to proceed with the payment?",showCancelButton:!0}).then(({isConfirmed:ue,isDenied:pe,isDismissed:xe})=>{ue&&oe(j,{onSettled:()=>{y.invalidateQueries(["student-fees"]),y.invalidateQueries(["current-fees-summary"]),n.setSubmitting(!1)},onSuccess:async()=>{f(Ge("Payment Done!")),_("/fee/print",{state:{feePrintData:{fullName:t.fullName,levelType:a==null?void 0:a.levelType,payment:j.payment[0]}}})},onError:()=>{f(Ye("An unknown error has occurred!"))}}),(pe||xe)&&(g({severity:"info",text:""}),n.setSubmitting(!1))})}const F=Oe({initialValues:{amount:{}},enableReinitialize:!0,onSubmit:de}),ce=()=>{T({type:"viewStudentFeeHistory",payload:{open:!0,data:{id:t==null?void 0:t._id,level:u.get("level_id")}}}),E(!0)},me=()=>N(!0);return e.jsxs(e.Fragment,{children:[e.jsx(De,{title:"Fees Payment",subtitle:"Access,manage and control payment of school fees",img:He.assessment,color:"primary.main"}),e.jsxs(d,{paddingY:4,spacing:2,children:[e.jsxs(d,{direction:{xs:"column-reverse",sm:"row"},justifyContent:{xs:"center",sm:"space-between"},alignItems:"center",children:[e.jsx(W,{sx:{width:250},fullWidth:!0,options:x!=null&&x.data?x.data:[],loading:x==null?void 0:x.isLoading,disableClearable:!0,closeText:" ",noOptionsText:"No Level Available",isOptionEqualToValue:(s,n)=>n.levelId===void 0||n.levelId===""||s.levelId===n.levelId,getOptionLabel:s=>s.levelType||"",value:a,onChange:(s,n)=>{Z(n),l(j=>(j.set("level_id",n==null?void 0:n.levelId),j.set("level_name",n==null?void 0:n.levelType),j))},onClose:()=>{B({})},renderInput:s=>e.jsx(b,{...s,label:"Select Level",size:"small"})}),e.jsx(G,{startIcon:e.jsx(K,{}),variant:"contained",onClick:me,children:"Payment History"})]}),e.jsx(W,{fullWidth:!0,options:R||[],loading:ie,disableClearable:!0,closeText:" ",noOptionsText:"No Student found",isOptionEqualToValue:(s,n)=>(n==null?void 0:n._id)===void 0||(n==null?void 0:n._id)===""||(s==null?void 0:s._id)===(n==null?void 0:n._id),getOptionLabel:s=>(s==null?void 0:s.fullName)||"",value:t,onChange:(s,n)=>B(n),renderInput:s=>e.jsx(b,{...s,placeholder:"Search for student"})})]}),e.jsxs(O,{container:!0,spacing:4,paddingY:2,children:[e.jsxs(O,{item:!0,xs:12,md:6,paddingY:6,children:[e.jsxs("div",{style:{display:"flex",gap:"4px",paddingBottom:"4px"},children:[e.jsx(Ie,{color:"secondary"}),e.jsx(o,{variant:"h6",children:"Personal Details"})]}),e.jsx(P,{}),e.jsx(d,{spacing:1,justifyContent:"center",alignItems:"center",paddingY:2,children:e.jsx(Ne,{src:(t==null?void 0:t.profile)===void 0||(t==null?void 0:t.profile)===""?null:t==null?void 0:t.profile,sx:{width:80,height:80}})}),e.jsxs(d,{spacing:2,paddingY:2,children:[e.jsx(b,{size:"small",label:"Student's Name",InputProps:{readOnly:!0},value:(t==null?void 0:t.fullName)||""}),e.jsx(b,{size:"small",value:(a==null?void 0:a.levelType)||u.get("level_name"),InputProps:{readOnly:!0}})]}),e.jsxs(d,{spacing:2,paddingY:2,children:[e.jsx(b,{type:"number",inputMode:"numeric",label:"Amount",size:"small",placeholder:"Enter Amount here",value:v,onChange:s=>ae(s.target.valueAsNumber),error:F.errors.amount,helperText:F.touched.amount&&F.errors.amount,InputProps:{startAdornment:e.jsx(Y,{position:"start",children:"GHS"}),endAdornment:e.jsx(Y,{position:"end",children:"p"})}}),e.jsx(Ee,{disabled:m.isEmpty(t==null?void 0:t._id),size:"large",variant:"contained",startIcon:e.jsx(U,{}),loading:le,onClick:F.handleSubmit,children:"Make Payment"})]})]}),e.jsxs(O,{item:!0,xs:12,md:6,paddingY:6,children:[e.jsxs("div",{style:{display:"flex",gap:"4px",paddingBottom:"4px"},children:[e.jsx(Ue,{color:"secondary"}),e.jsx(o,{variant:"h6",children:"Fees Details"})]}),e.jsx(P,{}),e.jsx(Be,{elevation:1,sx:{marginTop:2},children:e.jsxs(d,{spacing:2,padding:2,children:[e.jsx(G,{variant:"outlined",size:"small",onClick:ce,disabled:m.isEmpty(t==null?void 0:t._id),children:"Payment Details"}),e.jsxs(d,{direction:"row",justifyContent:"space-between",children:[e.jsx(o,{fontWeight:"bold",children:"Fees"}),!m.isEmpty(t==null?void 0:t._id)&&C===0?e.jsx(ke,{label:"Full Payment",color:"success",size:"medium",sx:{color:"white"},icon:e.jsx(ze,{})}):null]}),p.text&&e.jsxs(Re,{severity:p.severity,children:[p.text,p.text.startsWith("No")&&e.jsx(qe,{to:"/fee/new",children:"Add New Fee"})]}),e.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(o,{variant:"body2",children:"Fees For Term"}),e.jsx(o,{variant:"body2",children:m.isEmpty(t==null?void 0:t._id)?"GHS 0.00":h((a==null?void 0:a.fees)||0)})]}),e.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(o,{variant:"body2",children:"Arreas "}),e.jsx(o,{variant:"body2",children:h(w)})]}),e.jsx(P,{flexItem:!0}),e.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(o,{fontWeight:"bold",children:"Total "}),e.jsx(o,{variant:"body2",children:m.isEmpty(t==null?void 0:t._id)?"GHS 0.00":h(M)})]}),e.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(o,{fontWeight:"bold",children:"Fees Paid "}),e.jsx(o,{variant:"body2",children:m.isEmpty(t==null?void 0:t._id)?"GHS 0.00":h(A)})]}),e.jsx(P,{flexItem:!0}),e.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(o,{fontWeight:"bold",children:"Outstanding Fees "}),e.jsx(o,{variant:"body2",children:m.isEmpty(t==null?void 0:t._id)?"GHS 0.00":h(C)})]})]})})]})]}),e.jsx(J,{open:S,setOpen:N}),e.jsx(Ke,{open:X,setOpen:E})]})};export{ot as default};
