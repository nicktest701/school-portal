import{r as n,f as D,a0 as G,a1 as Q,H as Y,G as H,g as O,u as z,v as U,i as W,j as e,S as b,T as $,b as J,B,ax as K,J as Z,a6 as ee,q as te,O as se,_ as re,x as oe,s as ae,t as ie,ai as ne}from"./index-a08c4904.js";import{C as le,r as ce,c as ue}from"./CustomizedMaterialTable-b0814305.js";import{E as me}from"./images-ee905b8b.js";import{b as de}from"./ExaminationAPI-bc627310.js";import{g as pe}from"./generateCustomGrade-93281c1e.js";import{B as xe}from"./Back-26c0fe57.js";import{C as fe}from"./CustomTitle-d0e5d50c.js";import{A as he}from"./Autocomplete-62a3dcdf.js";import{N as Se}from"./NoteRounded-799b387a.js";import"./TabPanel-3210be1c.js";import"./Toolbar-172ad7c3.js";import"./MenuItem-ddd79fe9.js";import"./listItemTextClasses-cdd81f8c.js";import"./Chip-a33d5899.js";import"./Skeleton-f52aff28.js";import"./ButtonGroup-ed336fd9.js";import"./ListItemText-de69415f.js";import"./InputAdornment-16e34158.js";import"./CardContent-8cf1caa6.js";import"./ListItemSecondaryAction-33dcc31c.js";import"./Grid-d7986873.js";import"./useMediaQuery-dbbfc5b2.js";import"./ListItem-559aef15.js";import"./listItemButtonClasses-628cfd1a.js";import"./ListItemButton-b9f74f93.js";import"./Check-6932050c.js";import"./DeleteOutline-f3e83ed5.js";import"./Delete-ee750b69.js";import"./Add-3c6bb686.js";import"./ArrowBackRounded-b2e199d9.js";const Ue=()=>{var L;const y="text/csv",k="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",w="application/vnd.ms-excel",{schoolSessionDispatch:C}=n.useContext(D),{userState:{session:l}}=n.useContext(G),[c]=Q(),N=Y(),{levelId:d}=H(),E=O(),{state:u}=z(),[r,f]=n.useState([]),[h,m]=n.useState(!1),[F,v]=n.useState(""),[I,S]=n.useState(""),[o,R]=n.useState(c.get("sub")),a=U({queryKey:["subjects",d],queryFn:()=>ne(d),enabled:!!d,select:({subjects:t,grades:s})=>({subjects:t,grades:s})});n.useEffect(()=>{if((r==null?void 0:r.length)>0){const t=r==null?void 0:r.map(s=>({...s,subject:o}));f(t)}},[o]);function _(t){if(o===""){v("Please select a Subject!"),m(!1);return}S(!1),m(!0);const s=t.target.files[0];try{const i=new FileReader;s.type===y?i.readAsBinaryString(s):i.readAsArrayBuffer(s),i.onload=async function(P){let p=[];if((s.type===k||s.type===w)&&(p=ce(P.target.result)),s.type===y&&(p=ue(P.target.result)),p.length!==0){const X=p.map(x=>{var T;const g=Number(Object.values(x)[2]||0),j=Number(Object.values(x)[3]||0);if(g>50||j>50)throw S("It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50 marks!"),m(!1),f([]),"It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50";return{indexnumber:re.toString(Object.values(x)[0]),student:Object.values(x)[1],subject:o,classScore:g,examsScore:j,...pe(+g+ +j,(T=a==null?void 0:a.data)==null?void 0:T.grades)}}),V=await Promise.all(X);f(V)}}}catch(i){S(i)}finally{m(!1)}}const{mutateAsync:A}=W({mutationFn:de}),q=()=>{v(""),oe.fire({title:"Importing results",text:`Do you want to import results in ${o}?`,showCancelButton:!0}).then(({isConfirmed:t})=>{if(t){m(!0);const s={session:l==null?void 0:l.sessionId,term:l==null?void 0:l.termId,level:d,results:r};A(s,{onSettled:()=>{E.invalidateQueries(["all-results"]),E.invalidateQueries(["subject-score",d,c.get("sub")]),m(!1)},onSuccess:i=>{C(ae(i)),N(u==null?void 0:u.prevPath)},onError:i=>{C(ie(i))}})}})},M=[{title:"Index Number",field:"indexnumber"},{title:"Student",field:"student"},{title:"Subject",field:"subject",hidden:o||c.get("sub")},{title:"Class Score(50%)",field:"classScore"},{title:"Exams Score(50%)",field:"examsScore"},{title:"Total Score(100%)",field:"totalScore"},{title:"Grade",field:"grade"},{title:"Remarks",field:"remarks"}];return e.jsxs(e.Fragment,{children:[e.jsx(xe,{to:u==null?void 0:u.prevPath,color:"primary.main"}),e.jsx(fe,{title:"Exams Scores",subtitle:"Import Student exams results from excel or csv files.",color:"primary.main"}),e.jsxs(b,{spacing:2,py:4,px:2,my:4,border:"1px solid lightgray",children:[e.jsxs($,{children:["Select an ",e.jsx("b",{children:"EXCEL"})," OR ",e.jsx("b",{children:"CSV"})," file containing student results information. Make sure the columns matches the accepted fields."]}),e.jsxs(b,{direction:"row",spacing:3,pt:2,children:[e.jsx(he,{options:c.get("sub")!==null?[c.get("sub")]:(L=a==null?void 0:a.data)==null?void 0:L.subjects,loading:a==null?void 0:a.isLoading,getOptionLabel:t=>t||"",isOptionEqualToValue:(t,s)=>s===void 0||s===""||s===t,defaultValue:c.get("sub"),value:o,onChange:(t,s)=>R(s),sx:{minWidth:300},renderInput:t=>e.jsx(J,{...t,label:"Select Subject",size:"small",error:F!=="",helperText:F,required:!0,FormHelperTextProps:{sx:{color:"error.main"}}})}),e.jsxs(B,{variant:"contained",sx:{width:300,cursor:"pointer"},startIcon:e.jsx(Se,{}),children:[e.jsx("label",{style:{color:"#fff"},htmlFor:"resultFile",title:"Import results",children:h?"Please Wait...":"Upload File"}),e.jsx(K,{type:"file",id:"resultFile",name:"resultFile",hidden:!0,inputProps:{accept:".xlsx,.xls,.csv"},onChange:t=>_(t),onClick:t=>{t.target.value=null,t.currentTarget.value=null}})]})]})]}),e.jsx(Z,{children:e.jsxs(e.Fragment,{children:[I&&e.jsx(ee,{sx:{color:"red"},children:I}),e.jsx(le,{icon:me.score,search:!0,exportFileName:`${o} - `,isLoading:h,title:o,columns:M,data:r,actions:[],autoCompleteComponent:e.jsx(e.Fragment,{children:(r==null?void 0:r.length)>0&&e.jsxs(b,{direction:"row",spacing:3,justifyContent:"flex-end",children:[e.jsx(B,{children:"Cancel"}),e.jsx(te,{variant:"contained",onClick:q,children:"Save Results"})]})})})]})}),h&&e.jsx(se,{})]})};export{Ue as default};
