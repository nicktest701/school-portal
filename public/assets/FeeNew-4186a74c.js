import{c as ue,j as e,L as me,a as X,b as T,d as pe,e as je,D,r as d,U as ee,u as H,S as R,f as fe,g as P,_ as v,h as G,i as Y,C as te,F as se,k as he,A as ne,l as Q,m as L,n as V,T as B,o as ae,I as M,B as I,p as K,q as S,s as ie,t as le,v as oe,w as de,x as ce,y as ge,z as ye,E as ve,G as Se,H as Ce,J as Fe,K as be}from"./index-6e32062a.js";import{g as re,p as Ae,a as Te,f as Z,d as Le}from"./fee_ico-5f4e84da.js";import{g as Ee}from"./currentFeeAPI-faf7eec7.js";const we=ue(),Be=we,xe=({data:t,removeFee:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(me,{children:[e.jsx(X,{secondary:t==null?void 0:t.fee}),e.jsx(X,{secondary:T(t.amount)}),e.jsx(pe,{children:e.jsx(je,{size:"small",sx:{cursor:"pointer"},onClick:()=>a(t==null?void 0:t.fee),children:"Remove"})})]}),e.jsx(D,{})]}),Ne=({open:t,setOpen:a})=>{const{userState:{session:l}}=d.useContext(ee),h=H(),{schoolSessionDispatch:g}=d.useContext(R),[r,C]=d.useState({_id:"",type:""}),[y,F]=d.useState(""),[p,x]=d.useState(""),[u,b]=d.useState([]),[j,A]=d.useState(0),[N,E]=d.useState({severity:"",text:""}),{levelsOption:_}=fe();P(["fees"],()=>re(l),{enabled:!!(l!=null&&l.sessionId),onSuccess:s=>F(s)});const W={level:r,fee:u},i=()=>{p===""||j===""||(b(s=>s!==void 0?v.values(v.merge(v.keyBy([...s,{fee:p,amount:Number(j)}],"fee"))):[{fee:p,amount:Number(j)}]),x(""),A(""))},c=s=>{b(n=>n.filter(({fee:k})=>k!==s))},q=d.useMemo(()=>T(v.sumBy(u,"amount")),[u]),{mutateAsync:O}=G(Ae),z=(s,n)=>{E({text:""});const f={session:l.sessionId,term:l.termId,level:s.level._id,levelType:s.level.type,amount:s.fee},k=y.find(({_id:o})=>o===f.level);if(!v.isEmpty(k)){E({severity:"error",text:`Fees for ${f.levelType} already exists.Please try updating it.`});return}O(f,{onSettled:()=>{h.invalidateQueries(["fees"]),n.setSubmitting(!1)},onSuccess:o=>{g(de(o)),a(!1)},onError:o=>{g(ce(o))}})};return e.jsxs(Y,{open:t,onClose:()=>a(!1),fullWidth:!0,maxWidth:"xs",children:[e.jsx(te,{title:"New Fees",onClose:()=>a(!1)}),e.jsx(se,{initialValues:W,onSubmit:z,validationSchema:he,enableReinitialize:!0,children:({errors:s,touched:n,handleSubmit:f,isSubmitting:k})=>e.jsxs(e.Fragment,{children:[N.text&&e.jsx(ne,{sx:{marginY:1},severity:N.severity,onClose:()=>E({text:""}),children:N.text}),e.jsx(Q,{children:e.jsxs(L,{spacing:2,paddingY:2,children:[e.jsx(V,{fullWidth:!0,options:_,isOptionEqualToValue:(o,m)=>m._id===void 0||m._id===""||o._id===m._id,getOptionLabel:o=>o.type||"",value:r,onChange:(o,m)=>C(m),renderInput:o=>{var m,U,$,J;return e.jsx(B,{...o,label:"Select Level",size:"small",error:!!((m=n==null?void 0:n.level)!=null&&m.type&&((U=s==null?void 0:s.level)!=null&&U.type)),helperText:(($=n==null?void 0:n.level)==null?void 0:$.type)&&((J=s==null?void 0:s.level)==null?void 0:J.type)})}}),e.jsx(V,{freeSolo:!0,fullWidth:!0,options:ae,isOptionEqualToValue:(o,m)=>m===void 0||m===""||o===m,getOptionLabel:o=>o||"",value:p,onInputChange:(o,m)=>x(m),renderInput:o=>e.jsx(B,{...o,label:"Select Fee Type",size:"small",error:!!(n!=null&&n.fee&&(s!=null&&s.fee)),helperText:(n==null?void 0:n.fee)&&(s==null?void 0:s.fee)&&"Enter a least one fee type*"})}),e.jsx(B,{type:"number",label:"Enter Fee Amount",size:"small",InputProps:{startAdornment:e.jsx(M,{position:"start",children:"GHS"}),endAdornment:e.jsx(M,{position:"end",children:"p"})},value:j,onChange:o=>A(o.target.value),error:!!(n!=null&&n.fee&&(s!=null&&s.fee)),helperText:(n==null?void 0:n.fee)&&(s==null?void 0:s.fee)&&"Required*"}),e.jsx(I,{variant:"contained",size:"small",onClick:i,children:"Add"}),e.jsxs(K,{sx:{maxHeight:400},children:[e.jsx(S,{variant:"body1",sx:{fontWeight:"bold"},children:"Fees"}),v.isEmpty(u)?e.jsx(S,{children:"No Fee Available"}):u.map(o=>e.jsx(xe,{data:o,removeFee:c},o.fee)),e.jsx(D,{}),e.jsxs(L,{direction:"row",justifyContent:"space-between",children:[e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:"Total Fees"}),e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:q})]})]}),s.fee&&e.jsx(ie,{sx:{color:"error.main"},children:s.fee})]})}),e.jsx(le,{sx:{padding:2},children:e.jsx(oe,{loading:k,variant:"contained",onClick:f,children:"Save"})})]})})]})},Oe=()=>{var _,W;const t=H(),{schoolSessionState:{feeEditData:a},schoolSessionDispatch:l}=d.useContext(R),[h,g]=d.useState(""),[r,C]=d.useState([]),[y,F]=d.useState(0),[p,x]=d.useState({severity:"",text:""});d.useEffect(()=>{var i;C((i=a==null?void 0:a.data)==null?void 0:i.amount)},[a]);const u=()=>{h===""||y===""||(C(i=>i!==void 0?v.values(v.merge(v.keyBy([...i,{fee:h,amount:Number(y)}],"fee"))):[{fee:h,amount:Number(y)}]),g(""),F(""))},b=i=>{C(c=>c.filter(({fee:O})=>O!==i))},j=d.useMemo(()=>T(v.sumBy(r,"amount")),[r]),{mutateAsync:A}=G(Te),N=(i,c)=>{x({text:""}),A({_id:i._id,amount:i.fee},{onSettled:()=>{t.invalidateQueries(["fees"]),c.setSubmitting(!1)},onSuccess:()=>{x({severity:"info",text:"Changes Saved!!!"})}})},E=()=>{l({type:"setFeeEditData",payload:{open:!1,data:{}}})};return e.jsxs(Y,{open:a.open,onClose:E,fullWidth:!0,maxWidth:"xs",TransitionComponent:ge,children:[e.jsx(ye,{children:"Edit Fees"}),e.jsx(se,{initialValues:{_id:(_=a==null?void 0:a.data)==null?void 0:_._id,level:(W=a==null?void 0:a.data)==null?void 0:W.level,fee:r},onSubmit:N,enableReinitialize:!0,children:({errors:i,touched:c,handleSubmit:q,isSubmitting:O})=>{var z,s;return e.jsxs(e.Fragment,{children:[p.text&&e.jsx(ne,{sx:{marginY:1},severity:p.severity,onClose:()=>x({text:""}),children:p.text}),e.jsx(Q,{children:e.jsxs(L,{spacing:2,paddingY:2,children:[e.jsx(B,{label:" Level",size:"small",InputProps:{readOnly:!0},value:((z=a==null?void 0:a.data)==null?void 0:z.level)!==void 0?(s=a==null?void 0:a.data)==null?void 0:s.level:""}),e.jsx(V,{freeSolo:!0,fullWidth:!0,options:ae,isOptionEqualToValue:(n,f)=>f===void 0||f===""||n===f,getOptionLabel:n=>n||"",value:h,onInputChange:(n,f)=>g(f),renderInput:n=>e.jsx(B,{...n,label:"Select Fee Type",size:"small",error:!!(c!=null&&c.fee&&(i!=null&&i.fee)),helperText:(c==null?void 0:c.fee)&&(i==null?void 0:i.fee)&&"Enter a least one fee type*"})}),e.jsx(B,{type:"number",label:"Enter Fee Amount",size:"small",InputProps:{startAdornment:e.jsx(M,{position:"start",children:"GHS"}),endAdornment:e.jsx(M,{position:"end",children:"p"})},value:y,onChange:n=>F(n.target.value),error:!!(c!=null&&c.fee&&(i!=null&&i.fee)),helperText:(c==null?void 0:c.fee)&&(i==null?void 0:i.fee)&&"Required*"}),e.jsx(I,{variant:"contained",size:"small",onClick:u,children:"Add"}),e.jsxs(K,{sx:{maxHeight:400},children:[e.jsx(S,{variant:"body1",sx:{fontWeight:"bold"},children:"Fees"}),v.isEmpty(r)?e.jsx(S,{children:"No Fee Available"}):r.map(n=>e.jsx(xe,{data:n,removeFee:b},n.fee)),e.jsx(D,{}),e.jsxs(L,{direction:"row",justifyContent:"space-between",children:[e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:"Total Fees"}),e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:j})]})]}),i.fee&&e.jsx(ie,{sx:{color:"error.main"},children:i.fee})]})}),e.jsxs(le,{sx:{padding:2},children:[e.jsx(I,{onClick:E,children:"Cancel"}),e.jsx(oe,{loading:O,variant:"contained",onClick:q,children:"Save Changes"})]})]})}})]})};function w({title:t,value:a}){return e.jsxs(Be,{children:[e.jsx(S,{variant:"caption",color:"primary",children:t}),e.jsx(S,{variant:"body2",children:a})]})}function ke(){var g,r,C,y,F,p,x,u,b;const{schoolSessionState:{levelFeeInfo:t},schoolSessionDispatch:a}=d.useContext(R);console.log(t);const l=P({queryKey:["level-fee",t.data],queryFn:()=>Ee(t==null?void 0:t.data),enabled:!!((g=t==null?void 0:t.data)!=null&&g.term)&&!!((r=t==null?void 0:t.data)!=null&&r.level),onSuccess:j=>{console.log(j)}}),h=()=>{a({type:"viewLevelFeeInfo",payload:{open:!1,data:{}}})};return e.jsxs(Y,{open:t.open,fullWidth:!0,maxWidth:"xs",onClose:h,children:[e.jsx(te,{title:"School Fees Details",onClose:h}),e.jsxs(Q,{children:[(l==null?void 0:l.isLoading)&&e.jsx(S,{children:"Loading....."}),(l==null?void 0:l.data)!==void 0&&e.jsxs(L,{rowGap:2,children:[e.jsx(w,{title:"Level",value:(C=t==null?void 0:t.data)==null?void 0:C.levelName}),e.jsxs(L,{direction:"row",columnGap:2,children:[e.jsx(w,{title:" Total Fee",value:T((y=t==null?void 0:t.data)==null?void 0:y.fee)}),e.jsx(K,{children:t.data.amount&&t.data.amount.map(({fee:j,amount:A})=>e.jsxs(L,{paddingY:1,children:[e.jsx("small",{style:{color:"#00f"},children:j}),e.jsx("small",{children:T(A)})]},j))})]}),e.jsx(w,{title:"Number of Students",value:(F=t==null?void 0:t.data)==null?void 0:F.noOfStudents}),e.jsx(w,{title:"Total Expected Amount of Fees",value:T(((p=t==null?void 0:t.data)==null?void 0:p.fee)*((x=t==null?void 0:t.data)==null?void 0:x.noOfStudents))}),e.jsx(w,{title:"Total Amount of Fees Paid",value:T(l==null?void 0:l.data)}),e.jsx(w,{title:"Total Outstanding Fees",value:T(Number(((u=t==null?void 0:t.data)==null?void 0:u.fee)*((b=t==null?void 0:t.data)==null?void 0:b.noOfStudents))-Number(l==null?void 0:l.data))})]})]})]})}const ze=()=>{const{userState:{session:t}}=d.useContext(ee),a=H(),{schoolSessionDispatch:l}=d.useContext(R),[h,g]=d.useState(!1),r=P({queryKey:["fees"],queryFn:()=>re(t),enabled:!!(t!=null&&t.sessionId)}),{mutateAsync:C}=G(Le),y=x=>{be.fire({title:"Removing",text:"Do you want to remove Fee?",showCancelButton:!0}).then(({isConfirmed:u})=>{u&&C(x,{onSettled:()=>{a.invalidateQueries(["fees"])},onSuccess:()=>{l(de("Fee has been removed successfully!!!"))},onError:()=>{l(ce("Error removing Fee!!!"))}})})},F=x=>{l({type:"setFeeEditData",payload:{open:!0,data:x}})},p=({levelId:x,level:u,fee:b,noOfStudents:j,amount:A})=>{l({type:"viewLevelFeeInfo",payload:{open:!0,data:{noOfStudents:j,fee:b,level:x,levelName:u,term:t.termId,amount:A}}})};return e.jsxs(e.Fragment,{children:[e.jsxs(e.Fragment,{children:[e.jsx(ve,{title:"New Fee",subtitle:"Add new TERM/SEMESTER fees for a particular level",img:Z,color:"primary.main"}),e.jsx(Se,{title:"School Fees",icon:Z,columns:Ce(p,F,y),data:r.data?r.data:[],isLoading:r.isLoading,actions:[],search:!0,showAddButton:!0,addButtonText:"New Fee",addButtonImg:Fe.sms,addButtonMessage:"ðŸ˜‘ No School Fees available!.Create a new one",onAddButtonClicked:()=>g(!0)})]}),e.jsx(Ne,{open:h,setOpen:g}),e.jsx(Oe,{}),e.jsx(ke,{})]})};export{ze as default};
