import{r as l,S as Q,U as Y,O as D,P as G,Q as O,u as U,R as W,g as $,h as z,j as e,V as H,G as J,m as b,q as K,n as Z,T as ee,B as w,W as se,X as te,s as re,J as ae,M as ne,v as oe,Y as le,Z as ie,$ as ce,_ as ue,a0 as de,N as me,w as xe,x as pe,a1 as fe,a2 as he}from"./index-97ebb758.js";import{N as Se}from"./NoteRounded-632424b0.js";const be=()=>{var L;const y="text/csv",k="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",B="application/vnd.ms-excel",{schoolSessionDispatch:E}=l.useContext(Q),{userState:{session:i}}=l.useContext(Y),[c]=D(),N=G(),{levelId:m}=O(),C=U(),{state:u}=W(),[r,f]=l.useState([]),[h,d]=l.useState(!1),[F,v]=l.useState(""),[I,S]=l.useState(""),[a,R]=l.useState(c.get("sub")),n=$({queryKey:["subjects",m],queryFn:()=>fe(m),enabled:!!m,select:({subjects:s,grades:t})=>({subjects:s,grades:t})});l.useEffect(()=>{if((r==null?void 0:r.length)>0){const s=r==null?void 0:r.map(t=>({...t,subject:a}));f(s)}},[a]);function _(s){if(a===""){v("Please select a Subject!"),d(!1);return}S(!1),d(!0);const t=s.target.files[0];try{const o=new FileReader;t.type===y?o.readAsBinaryString(t):o.readAsArrayBuffer(t),o.onload=async function(P){let x=[];if((t.type===k||t.type===B)&&(x=ie(P.target.result)),t.type===y&&(x=ce(P.target.result)),x.length!==0){const A=x.map(p=>{var T;const g=Number(Object.values(p)[2]||0),j=Number(Object.values(p)[3]||0);if(g>50||j>50)throw S("It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50 marks!"),d(!1),f([]),"It seems there is some inconsistencies in your results.Class score or Exams score cannot be more than 50";return{indexnumber:ue.toString(Object.values(p)[0]),student:Object.values(p)[1],subject:a,classScore:g,examsScore:j,...de(+g+ +j,(T=n==null?void 0:n.data)==null?void 0:T.grades)}}),V=await Promise.all(A);f(V)}}}catch(o){S(o)}finally{d(!1)}}const{mutateAsync:M}=z({mutationFn:he}),X=()=>{v(""),me.fire({title:"Importing results",text:`Do you want to import results in ${a}?`,showCancelButton:!0}).then(({isConfirmed:s})=>{if(s){d(!0);const t={session:i==null?void 0:i.sessionId,term:i==null?void 0:i.termId,level:m,results:r};M(t,{onSettled:()=>{C.invalidateQueries(["all-results"]),C.invalidateQueries(["subject-score",m,c.get("sub")]),d(!1)},onSuccess:o=>{E(xe(o)),N(u==null?void 0:u.prevPath)},onError:o=>{E(pe(o))}})}})},q=[{title:"Index Number",field:"indexnumber"},{title:"Student",field:"student"},{title:"Subject",field:"subject",hidden:a||c.get("sub")},{title:"Class Score(50%)",field:"classScore"},{title:"Exams Score(50%)",field:"examsScore"},{title:"Total Score(100%)",field:"totalScore"},{title:"Grade",field:"grade"},{title:"Remarks",field:"remarks"}];return e.jsxs(e.Fragment,{children:[e.jsx(H,{to:u==null?void 0:u.prevPath,color:"primary.main"}),e.jsx(J,{title:"Exams Scores",subtitle:"Import Student exams results from excel or csv files.",color:"primary.main"}),e.jsxs(b,{spacing:2,py:4,px:2,my:4,border:"1px solid lightgray",children:[e.jsxs(K,{children:["Select an ",e.jsx("b",{children:"EXCEL"})," OR ",e.jsx("b",{children:"CSV"})," file containing student results information. Make sure the columns matches the accepted fields."]}),e.jsxs(b,{direction:"row",spacing:3,pt:2,children:[e.jsx(Z,{options:c.get("sub")!==null?[c.get("sub")]:(L=n==null?void 0:n.data)==null?void 0:L.subjects,loading:n==null?void 0:n.isLoading,getOptionLabel:s=>s||"",isOptionEqualToValue:(s,t)=>t===void 0||t===""||t===s,defaultValue:c.get("sub"),value:a,onChange:(s,t)=>R(t),sx:{minWidth:300},renderInput:s=>e.jsx(ee,{...s,label:"Select Subject",size:"small",error:F!=="",helperText:F,required:!0,FormHelperTextProps:{sx:{color:"error.main"}}})}),e.jsxs(w,{variant:"contained",sx:{width:300,cursor:"pointer"},startIcon:e.jsx(Se,{}),children:[e.jsx("label",{style:{color:"#fff"},htmlFor:"resultFile",title:"Import results",children:h?"Please Wait...":"Upload File"}),e.jsx(se,{type:"file",id:"resultFile",name:"resultFile",hidden:!0,inputProps:{accept:".xlsx,.xls,.csv"},onChange:s=>_(s),onClick:s=>{s.target.value=null,s.currentTarget.value=null}})]})]})]}),e.jsx(te,{children:e.jsxs(e.Fragment,{children:[I&&e.jsx(re,{sx:{color:"red"},children:I}),e.jsx(ae,{icon:ne.score,search:!0,exportFileName:`${a} - `,isLoading:h,title:a,columns:q,data:r,actions:[],autoCompleteComponent:e.jsx(e.Fragment,{children:(r==null?void 0:r.length)>0&&e.jsxs(b,{direction:"row",spacing:3,justifyContent:"flex-end",children:[e.jsx(w,{children:"Cancel"}),e.jsx(oe,{variant:"contained",onClick:X,children:"Save Results"})]})})})]})}),h&&e.jsx(le,{})]})};export{be as default};
