import{aA as ue,j as e,D as I,r,a0 as ee,b as P,S as R,c as H,_ as v,d as Q,v as Y,w as te,y as se,aB as pe,K as ne,x as G,l as T,T as O,B as V,L as K,m as S,a8 as ae,E as ie,Q as le,g as oe,h as re,al as fe,aC as je,e as he,f as ge}from"./index-ce442eb1.js";import{g as de,p as ye,a as ve,d as Se}from"./feeAPI-aa1bfb55.js";import{L as Ce,C as Fe}from"./CustomizedMaterialTable-06b57d17.js";import{F as ce,e as be}from"./sessionColumns-a7ba1da8.js";import{c as L}from"./currencyFormatter-1910a788.js";import{L as Ae}from"./ListItem-2727fabf.js";import{L as X}from"./ListItemText-b107adf9.js";import{L as Le}from"./ListItemSecondaryAction-660d9daa.js";import{u as Te}from"./useLevel-0efe41ff.js";import{A as D}from"./Autocomplete-87c4b1e1.js";import{I as M}from"./InputAdornment-92a613d9.js";import{D as me}from"./DialogActions-c9d7df2e.js";import{E as Ee}from"./images-ee905b8b.js";import{b as we}from"./currentFeeAPI-8639b338.js";import{f as Z}from"./fee_ico-578bcc38.js";import"./TabPanel-47a179c1.js";import"./Toolbar-8b116404.js";import"./Chip-15117b24.js";import"./Skeleton-b715010d.js";import"./ButtonGroup-ca857561.js";import"./useMediaQuery-5bcb3f64.js";import"./ListItemButton-97ec9750.js";import"./listItemButtonClasses-c7063ebe.js";import"./Check-4cc8eef7.js";import"./DeleteOutline-78b9d3f1.js";import"./Delete-fb41f478.js";import"./CircleRounded-06f2dceb.js";import"./Edit-009e8578.js";const Be=ue(),Ne=Be,xe=({data:t,removeFee:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(Ae,{children:[e.jsx(X,{secondary:t==null?void 0:t.fee}),e.jsx(X,{secondary:L(t.amount)}),e.jsx(Le,{children:e.jsx(Ce,{size:"small",sx:{cursor:"pointer"},onClick:()=>a(t==null?void 0:t.fee),children:"Remove"})})]}),e.jsx(I,{})]}),Oe=({open:t,setOpen:a})=>{const{userState:{session:l}}=r.useContext(ee),h=P(),{schoolSessionDispatch:g}=r.useContext(R),[c,C]=r.useState({_id:"",type:""}),[y,F]=r.useState(""),[p,m]=r.useState(""),[x,b]=r.useState([]),[f,A]=r.useState(0),[_,E]=r.useState({severity:"",text:""}),{levelsOption:k}=Te();H(["fees"],()=>de(l),{enabled:!!(l!=null&&l.sessionId),onSuccess:s=>F(s)});const W={level:c,fee:x},i=()=>{p===""||f===""||(b(s=>s!==void 0?v.values(v.merge(v.keyBy([...s,{fee:p,amount:Number(f)}],"fee"))):[{fee:p,amount:Number(f)}]),m(""),A(""))},d=s=>{b(n=>n.filter(({fee:B})=>B!==s))},q=r.useMemo(()=>L(v.sumBy(x,"amount")),[x]),{mutateAsync:w}=Q(ye),z=(s,n)=>{E({text:""});const j={session:l.sessionId,term:l.termId,level:s.level._id,levelType:s.level.type,amount:s.fee},B=y.find(({_id:o})=>o===j.level);if(!v.isEmpty(B)){E({severity:"error",text:`Fees for ${j.levelType} already exists.Please try updating it.`});return}w(j,{onSettled:()=>{h.invalidateQueries(["fees"]),n.setSubmitting(!1)},onSuccess:o=>{g(oe(o)),a(!1)},onError:o=>{g(re(o))}})};return e.jsxs(Y,{open:t,onClose:()=>a(!1),fullWidth:!0,maxWidth:"xs",children:[e.jsx(te,{title:"New Fees",onClose:()=>a(!1)}),e.jsx(se,{initialValues:W,onSubmit:z,validationSchema:pe,enableReinitialize:!0,children:({errors:s,touched:n,handleSubmit:j,isSubmitting:B})=>e.jsxs(e.Fragment,{children:[_.text&&e.jsx(ne,{sx:{marginY:1},severity:_.severity,onClose:()=>E({text:""}),children:_.text}),e.jsx(G,{children:e.jsxs(T,{spacing:2,paddingY:2,children:[e.jsx(D,{fullWidth:!0,options:k,isOptionEqualToValue:(o,u)=>u._id===void 0||u._id===""||o._id===u._id,getOptionLabel:o=>o.type||"",value:c,onChange:(o,u)=>C(u),renderInput:o=>{var u,$,U,J;return e.jsx(O,{...o,label:"Select Level",size:"small",error:!!((u=n==null?void 0:n.level)!=null&&u.type&&(($=s==null?void 0:s.level)!=null&&$.type)),helperText:((U=n==null?void 0:n.level)==null?void 0:U.type)&&((J=s==null?void 0:s.level)==null?void 0:J.type)})}}),e.jsx(D,{freeSolo:!0,fullWidth:!0,options:ce,isOptionEqualToValue:(o,u)=>u===void 0||u===""||o===u,getOptionLabel:o=>o||"",value:p,onInputChange:(o,u)=>m(u),renderInput:o=>e.jsx(O,{...o,label:"Select Fee Type",size:"small",error:!!(n!=null&&n.fee&&(s!=null&&s.fee)),helperText:(n==null?void 0:n.fee)&&(s==null?void 0:s.fee)&&"Enter a least one fee type*"})}),e.jsx(O,{type:"number",label:"Enter Fee Amount",size:"small",InputProps:{startAdornment:e.jsx(M,{position:"start",children:"GHS"}),endAdornment:e.jsx(M,{position:"end",children:"p"})},value:f,onChange:o=>A(o.target.value),error:!!(n!=null&&n.fee&&(s!=null&&s.fee)),helperText:(n==null?void 0:n.fee)&&(s==null?void 0:s.fee)&&"Required*"}),e.jsx(V,{variant:"contained",size:"small",onClick:i,children:"Add"}),e.jsxs(K,{sx:{maxHeight:400},children:[e.jsx(S,{variant:"body1",sx:{fontWeight:"bold"},children:"Fees"}),v.isEmpty(x)?e.jsx(S,{children:"No Fee Available"}):x.map(o=>e.jsx(xe,{data:o,removeFee:d},o.fee)),e.jsx(I,{}),e.jsxs(T,{direction:"row",justifyContent:"space-between",children:[e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:"Total Fees"}),e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:q})]})]}),s.fee&&e.jsx(ae,{sx:{color:"error.main"},children:s.fee})]})}),e.jsx(me,{sx:{padding:2},children:e.jsx(ie,{loading:B,variant:"contained",onClick:j,children:"Save"})}),B&&e.jsx(le,{value:"Adding New Fee..."})]})})]})},_e=()=>{var k,W;const t=P(),{schoolSessionState:{feeEditData:a},schoolSessionDispatch:l}=r.useContext(R),[h,g]=r.useState(""),[c,C]=r.useState([]),[y,F]=r.useState(0),[p,m]=r.useState({severity:"",text:""});r.useEffect(()=>{var i;C((i=a==null?void 0:a.data)==null?void 0:i.amount)},[a]);const x=()=>{h===""||y===""||(C(i=>i!==void 0?v.values(v.merge(v.keyBy([...i,{fee:h,amount:Number(y)}],"fee"))):[{fee:h,amount:Number(y)}]),g(""),F(""))},b=i=>{C(d=>d.filter(({fee:w})=>w!==i))},f=r.useMemo(()=>L(v.sumBy(c,"amount")),[c]),{mutateAsync:A}=Q(ve),_=(i,d)=>{m({text:""}),A({_id:i._id,amount:i.fee},{onSettled:()=>{t.invalidateQueries(["fees"]),d.setSubmitting(!1)},onSuccess:()=>{m({severity:"info",text:"Changes Saved!!!"})}})},E=()=>{l({type:"setFeeEditData",payload:{open:!1,data:{}}})};return e.jsxs(Y,{open:a.open,onClose:E,fullWidth:!0,maxWidth:"xs",TransitionComponent:fe,children:[e.jsx(je,{children:"Edit Fees"}),e.jsx(se,{initialValues:{_id:(k=a==null?void 0:a.data)==null?void 0:k._id,level:(W=a==null?void 0:a.data)==null?void 0:W.level,fee:c},onSubmit:_,enableReinitialize:!0,children:({errors:i,touched:d,handleSubmit:q,isSubmitting:w})=>{var z,s;return e.jsxs(e.Fragment,{children:[p.text&&e.jsx(ne,{sx:{marginY:1},severity:p.severity,onClose:()=>m({text:""}),children:p.text}),e.jsx(G,{children:e.jsxs(T,{spacing:2,paddingY:2,children:[e.jsx(O,{label:" Level",size:"small",InputProps:{readOnly:!0},value:((z=a==null?void 0:a.data)==null?void 0:z.level)!==void 0?(s=a==null?void 0:a.data)==null?void 0:s.level:""}),e.jsx(D,{freeSolo:!0,fullWidth:!0,options:ce,isOptionEqualToValue:(n,j)=>j===void 0||j===""||n===j,getOptionLabel:n=>n||"",value:h,onInputChange:(n,j)=>g(j),renderInput:n=>e.jsx(O,{...n,label:"Select Fee Type",size:"small",error:!!(d!=null&&d.fee&&(i!=null&&i.fee)),helperText:(d==null?void 0:d.fee)&&(i==null?void 0:i.fee)&&"Enter a least one fee type*"})}),e.jsx(O,{type:"number",label:"Enter Fee Amount",size:"small",InputProps:{startAdornment:e.jsx(M,{position:"start",children:"GHS"}),endAdornment:e.jsx(M,{position:"end",children:"p"})},value:y,onChange:n=>F(n.target.value),error:!!(d!=null&&d.fee&&(i!=null&&i.fee)),helperText:(d==null?void 0:d.fee)&&(i==null?void 0:i.fee)&&"Required*"}),e.jsx(V,{variant:"contained",size:"small",onClick:x,children:"Add"}),e.jsxs(K,{sx:{maxHeight:400},children:[e.jsx(S,{variant:"body1",sx:{fontWeight:"bold"},children:"Fees"}),v.isEmpty(c)?e.jsx(S,{children:"No Fee Available"}):c.map(n=>e.jsx(xe,{data:n,removeFee:b},n.fee)),e.jsx(I,{}),e.jsxs(T,{direction:"row",justifyContent:"space-between",children:[e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:"Total Fees"}),e.jsx(S,{variant:"h6",sx:{fontWeight:"bold"},children:f})]})]}),i.fee&&e.jsx(ae,{sx:{color:"error.main"},children:i.fee})]})}),e.jsxs(me,{sx:{padding:2},children:[e.jsx(V,{onClick:E,children:"Cancel"}),e.jsx(ie,{loading:w,variant:"contained",onClick:q,children:"Save Changes"})]}),w&&e.jsx(le,{value:"Saving Changes..."})]})}})]})};function N({title:t,value:a}){return e.jsxs(Ne,{children:[e.jsx(S,{variant:"caption",color:"primary",children:t}),e.jsx(S,{variant:"body2",children:a})]})}function ke(){var g,c,C,y,F,p,m,x,b;const{schoolSessionState:{levelFeeInfo:t},schoolSessionDispatch:a}=r.useContext(R);console.log(t);const l=H({queryKey:["level-fee",t.data],queryFn:()=>we(t==null?void 0:t.data),enabled:!!((g=t==null?void 0:t.data)!=null&&g.term)&&!!((c=t==null?void 0:t.data)!=null&&c.level),onSuccess:f=>{console.log(f)}}),h=()=>{a({type:"viewLevelFeeInfo",payload:{open:!1,data:{}}})};return e.jsxs(Y,{open:t.open,fullWidth:!0,maxWidth:"xs",onClose:h,children:[e.jsx(te,{title:"School Fees Details",onClose:h}),e.jsxs(G,{children:[(l==null?void 0:l.isLoading)&&e.jsx(S,{children:"Loading....."}),(l==null?void 0:l.data)!==void 0&&e.jsxs(T,{rowGap:2,children:[e.jsx(N,{title:"Level",value:(C=t==null?void 0:t.data)==null?void 0:C.levelName}),e.jsxs(T,{direction:"row",columnGap:2,children:[e.jsx(N,{title:" Total Fee",value:L((y=t==null?void 0:t.data)==null?void 0:y.fee)}),e.jsx(K,{children:t.data.amount&&t.data.amount.map(({fee:f,amount:A})=>e.jsxs(T,{paddingY:1,children:[e.jsx("small",{style:{color:"#00f"},children:f}),e.jsx("small",{children:L(A)})]},f))})]}),e.jsx(N,{title:"Number of Students",value:(F=t==null?void 0:t.data)==null?void 0:F.noOfStudents}),e.jsx(N,{title:"Total Expected Amount of Fees",value:L(((p=t==null?void 0:t.data)==null?void 0:p.fee)*((m=t==null?void 0:t.data)==null?void 0:m.noOfStudents))}),e.jsx(N,{title:"Total Amount of Fees Paid",value:L(l==null?void 0:l.data)}),e.jsx(N,{title:"Total Outstanding Fees",value:L(Number(((x=t==null?void 0:t.data)==null?void 0:x.fee)*((b=t==null?void 0:t.data)==null?void 0:b.noOfStudents))-Number(l==null?void 0:l.data))})]})]})]})}const dt=()=>{const{userState:{session:t}}=r.useContext(ee),a=P(),{schoolSessionDispatch:l}=r.useContext(R),[h,g]=r.useState(!1),c=H({queryKey:["fees"],queryFn:()=>de(t),enabled:!!(t!=null&&t.sessionId)}),{mutateAsync:C}=Q(Se),y=m=>{ge.fire({title:"Removing",text:"Do you want to remove Fee?",showCancelButton:!0}).then(({isConfirmed:x})=>{x&&C(m,{onSettled:()=>{a.invalidateQueries(["fees"])},onSuccess:()=>{l(oe("Fee has been removed successfully!!!"))},onError:()=>{l(re("Error removing Fee!!!"))}})})},F=m=>{l({type:"setFeeEditData",payload:{open:!0,data:m}})},p=({levelId:m,level:x,fee:b,noOfStudents:f,amount:A})=>{l({type:"viewLevelFeeInfo",payload:{open:!0,data:{noOfStudents:f,fee:b,level:m,levelName:x,term:t.termId,amount:A}}})};return e.jsxs(e.Fragment,{children:[e.jsxs(e.Fragment,{children:[e.jsx(he,{title:"New Fee",subtitle:"Add new TERM/SEMESTER fees for a particular level",img:Z,color:"primary.main"}),e.jsx(Fe,{title:"School Fees",icon:Z,columns:be(p,F,y),data:c.data?c.data:[],isLoading:c.isLoading,actions:[],search:!0,showAddButton:!0,addButtonText:"New Fee",addButtonImg:Ee.sms,addButtonMessage:"😑 No School Fees available!.Create a new one",onAddButtonClicked:()=>g(!0)})]}),e.jsx(Oe,{open:h,setOpen:g}),e.jsx(_e,{}),e.jsx(ke,{})]})};export{dt as default};
